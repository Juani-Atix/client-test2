'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _sort = require('babel-runtime/core-js/array/sort');

var _sort2 = _interopRequireDefault(_sort);

var _concat = require('babel-runtime/core-js/array/concat');

var _concat2 = _interopRequireDefault(_concat);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _asar = require('asar');

var _asar2 = _interopRequireDefault(_asar);

var _assignIn = require('lodash/assignIn');

var _assignIn2 = _interopRequireDefault(_assignIn);

var _babelCore = require('babel-core');

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _del = require('del');

var _del2 = _interopRequireDefault(_del);

var _babelPresetEs = require('babel-preset-es2015');

var _babelPresetEs2 = _interopRequireDefault(_babelPresetEs);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _glob = require('glob');

var _glob2 = _interopRequireDefault(_glob);

var _babelPresetNode = require('babel-preset-node6');

var _babelPresetNode2 = _interopRequireDefault(_babelPresetNode);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _crossSpawn = require('cross-spawn');

var _crossSpawn2 = _interopRequireDefault(_crossSpawn);

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _uglifyJs = require('uglify-js');

var _uglifyJs2 = _interopRequireDefault(_uglifyJs);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

var _electronAppScaffold = require('./electronAppScaffold');

var _electronAppScaffold2 = _interopRequireDefault(_electronAppScaffold);

var _dependenciesManager = require('./dependenciesManager');

var _dependenciesManager2 = _interopRequireDefault(_dependenciesManager);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_shelljs2.default.config.fatal = true;

/**
 * Represents the .desktop dir scaffold.
 * @class
 */

var ElectronApp = function () {

    /**
     * @param {MeteorDesktop} $ - context
     * @constructor
     */
    function ElectronApp($) {
        (0, _classCallCheck3.default)(this, ElectronApp);

        this.log = new _log2.default('electronApp');
        this.scaffold = new _electronAppScaffold2.default($);
        this.depsManager = new _dependenciesManager2.default($, this.scaffold.getDefaultPackageJson().dependencies);
        this.$ = $;
        this.meteorApp = this.$.meteorApp;
        this.packageJson = null;
        this.version = null;
        this.compatibilityVersion = null;
    }

    /**
     * Makes an app.asar from the skeleton app.
     * @property {Array} excludeFromDel - list of paths to exclude from deleting
     * @returns {Promise}
     */


    (0, _createClass3.default)(ElectronApp, [{
        key: 'packSkeletonToAsar',
        value: function packSkeletonToAsar() {
            var _this = this;

            var excludeFromDel = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];

            this.log.info('packing skeleton app and node_modules to asar archive');
            return new _promise2.default(function (resolve) {
                // We want to pack skeleton app and node_modules together, so we need to temporarily
                // move node_modules to app dir.
                _this.log.debug('moving node_modules to app dir');
                _shelljs2.default.mv(_this.$.env.paths.electronApp.nodeModules, _path2.default.join(_this.$.env.paths.electronApp.appRoot, 'node_modules'));
                _this.log.debug('packing');
                _asar2.default.createPackage(_this.$.env.paths.electronApp.appRoot, _this.$.env.paths.electronApp.appAsar, function () {
                    // Lets move the node_modules back.
                    _this.log.debug('moving node_modules back from app dir');
                    _shelljs2.default.mv(_path2.default.join(_this.$.env.paths.electronApp.appRoot, 'node_modules'), _this.$.env.paths.electronApp.nodeModules);
                    _this.log.debug('deleting source files');
                    var exclude = (0, _concat2.default)([_this.$.env.paths.electronApp.nodeModules, _this.$.env.paths.electronApp.appAsar, _this.$.env.paths.electronApp.packageJson], excludeFromDel);

                    _del2.default.sync((0, _concat2.default)(['' + _this.$.env.paths.electronApp.root + _path2.default.sep + '*'], exclude.map(function (pathToExclude) {
                        return '!' + pathToExclude;
                    })));
                    resolve();
                });
            });
        }

        /**
         * Calculates a md5 from all dependencies.
         */

    }, {
        key: 'calculateCompatibilityVersion',
        value: function calculateCompatibilityVersion() {
            var _this2 = this;

            this.log.verbose('calculating compatibility version');
            var md5 = _crypto2.default.createHash('md5');
            var dependencies = (0, _sort2.default)((0, _keys2.default)(this.packageJson.dependencies));
            dependencies = dependencies.map(function (dependency) {
                return dependency + ':' + _this2.packageJson.dependencies[dependency];
            });
            var mainCompatibilityVersion = this.$.getVersion().split('.');
            this.log.debug('meteor-desktop compatibility version is ', mainCompatibilityVersion[0] + '.' + mainCompatibilityVersion[1]);
            dependencies.push('meteor-desktop:' + mainCompatibilityVersion[0] + '.' + mainCompatibilityVersion[1]);

            var desktopCompatibilityVersion = this.$.desktop.getSettings().version.split('.')[0];
            this.log.debug('.desktop compatibility version is ', desktopCompatibilityVersion);
            dependencies.push('desktop-app:' + desktopCompatibilityVersion);

            if (process.env.METEOR_DESKTOP_DEBUG_DESKTOP_COMPATIBILITY_VERSION || process.env.METEOR_DESKTOP_DEBUG) {
                this.log.debug('compatibility version calculated from ' + (0, _stringify2.default)(dependencies));
            }

            md5.update((0, _stringify2.default)(dependencies));
            this.compatibilityVersion = md5.digest('hex');
        }

        /**
         * Runs all necessary tasks to build the desktopified app.
         */

    }, {
        key: 'build',
        value: function () {
            var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee() {
                var run = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;
                return _regenerator2.default.wrap(function _callee$(_context) {
                    while (1) {
                        switch (_context.prev = _context.next) {
                            case 0:
                                // TODO: refactor to a task runner
                                this.log.info('scaffolding');

                                if (!this.$.desktop.check()) {
                                    if (!this.$.env.options.scaffold) {
                                        this.log.error('seems that you do not have a .desktop dir in your project or it is' + ' corrupted. Run \'npm run desktop -- init\' to get a new one.');
                                        // Do not fail, so that npm will not print his error stuff to console.
                                        process.exit(0);
                                    } else {
                                        this.$.desktop.scaffold();
                                        this.$.meteorApp.updateGitIgnore();
                                    }
                                }

                                try {
                                    this.$.meteorApp.updateGitIgnore();
                                } catch (e) {
                                    this.log.warn('error occurred while adding ' + this.$.env.paths.electronApp.rootName + 'to .gitignore: ', e);
                                }

                                _context.prev = 3;
                                _context.next = 6;
                                return this.$.meteorApp.ensureDesktopHCPPackages();

                            case 6:
                                _context.next = 12;
                                break;

                            case 8:
                                _context.prev = 8;
                                _context.t0 = _context['catch'](3);

                                this.log.error('error while checking for required packages: ', _context.t0);
                                process.exit(1);

                            case 12:
                                _context.prev = 12;
                                _context.next = 15;
                                return this.scaffold.make();

                            case 15:
                                _context.next = 21;
                                break;

                            case 17:
                                _context.prev = 17;
                                _context.t1 = _context['catch'](12);

                                this.log.error('error while scaffolding: ', _context.t1);
                                process.exit(1);

                            case 21:

                                try {
                                    this.updatePackageJsonFields();
                                } catch (e) {
                                    this.log.error('error while updating package.json: ', e);
                                }

                                try {
                                    this.updateDependenciesList();
                                } catch (e) {
                                    this.log.error('error while merging dependencies list: ', e);
                                }

                                try {
                                    this.calculateCompatibilityVersion();
                                } catch (e) {
                                    this.log.error('error while calculating compatibility version: ', e);
                                    process.exit(1);
                                }

                                _context.prev = 24;
                                _context.next = 27;
                                return this.handleTemporaryNodeModules();

                            case 27:
                                _context.next = 33;
                                break;

                            case 29:
                                _context.prev = 29;
                                _context.t2 = _context['catch'](24);

                                this.log.error('error occurred while handling temporary node_modules: ', _context.t2);
                                process.exit(1);

                            case 33:
                                _context.prev = 33;
                                _context.next = 36;
                                return this.ensureDeps();

                            case 36:
                                _context.next = 42;
                                break;

                            case 38:
                                _context.prev = 38;
                                _context.t3 = _context['catch'](33);

                                this.log.error('error occurred while running npm: ', _context.t3);
                                process.exit(1);

                            case 42:
                                _context.prev = 42;
                                _context.next = 45;
                                return this.ensureMeteorDependencies();

                            case 45:
                                _context.next = 51;
                                break;

                            case 47:
                                _context.prev = 47;
                                _context.t4 = _context['catch'](42);

                                this.log.error('error occurred while running npm: ', _context.t4);
                                process.exit(1);

                            case 51:
                                _context.prev = 51;
                                _context.next = 54;
                                return this.rebuildDeps();

                            case 54:
                                _context.next = 60;
                                break;

                            case 56:
                                _context.prev = 56;
                                _context.t5 = _context['catch'](51);

                                this.log.error('error occurred while rebuilding native node modules: ', _context.t5);
                                process.exit(1);

                            case 60:
                                if (!this.$.env.isProductionBuild()) {
                                    _context.next = 70;
                                    break;
                                }

                                _context.prev = 61;
                                _context.next = 64;
                                return this.packSkeletonToAsar();

                            case 64:
                                _context.next = 70;
                                break;

                            case 66:
                                _context.prev = 66;
                                _context.t6 = _context['catch'](61);

                                this.log.error('error while packing skeleton to asar: ', _context.t6);
                                process.exit(1);

                            case 70:

                                // TODO: find a way to avoid copying .desktop to a temp location
                                try {
                                    this.copyDesktopToDesktopTemp();
                                } catch (e) {
                                    this.log.error('error while copying .desktop to a temporary location: ', e);
                                    process.exit(1);
                                }

                                try {
                                    this.updateSettingsJsonFields();
                                } catch (e) {
                                    this.log.error('error while updating settings.json: ', e);
                                    process.exit(1);
                                }

                                _context.prev = 72;
                                _context.next = 75;
                                return this.excludeFilesFromArchive();

                            case 75:
                                _context.next = 81;
                                break;

                            case 77:
                                _context.prev = 77;
                                _context.t7 = _context['catch'](72);

                                this.log.error('error while excluding files from packing to asar: ', _context.t7);
                                process.exit(1);

                            case 81:

                                try {
                                    this.transpileAndMinify();
                                } catch (e) {
                                    this.log.error('error while transpiling or minifying: ', e);
                                }

                                _context.prev = 82;
                                _context.next = 85;
                                return this.packDesktopToAsar();

                            case 85:
                                _context.next = 91;
                                break;

                            case 87:
                                _context.prev = 87;
                                _context.t8 = _context['catch'](82);

                                this.log.error('error occurred while packing .desktop to asar: ', _context.t8);
                                process.exit(1);

                            case 91:
                                _context.prev = 91;
                                _context.next = 94;
                                return this.getMeteorClientBuild();

                            case 94:
                                _context.next = 99;
                                break;

                            case 96:
                                _context.prev = 96;
                                _context.t9 = _context['catch'](91);

                                this.log.error('error occurred during getting meteor mobile build: ', _context.t9);

                            case 99:

                                if (run) {
                                    this.log.info('running');
                                    this.$.electron.run();
                                } else {
                                    this.log.info('built');
                                }

                            case 100:
                            case 'end':
                                return _context.stop();
                        }
                    }
                }, _callee, this, [[3, 8], [12, 17], [24, 29], [33, 38], [42, 47], [51, 56], [61, 66], [72, 77], [82, 87], [91, 96]]);
            }));

            function build() {
                return _ref.apply(this, arguments);
            }

            return build;
        }()

        /**
         * Ensures all required dependencies are added to the Meteor project.
         * @returns {Promise.<void>}
         */

    }, {
        key: 'ensureMeteorDependencies',
        value: function () {
            var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2() {
                var _this3 = this;

                var packages, packagesWithVersion, plugins;
                return _regenerator2.default.wrap(function _callee2$(_context2) {
                    while (1) {
                        switch (_context2.prev = _context2.next) {
                            case 0:
                                packages = [];
                                packagesWithVersion = [];
                                plugins = 'plugins [';


                                (0, _keys2.default)(this.$.desktop.getDependencies().plugins).forEach(function (plugin) {
                                    // Read package.json of the plugin.
                                    var packageJson = JSON.parse(_fs2.default.readFileSync(_path2.default.join(_this3.$.env.paths.electronApp.nodeModules, plugin, 'package.json'), 'utf8'));

                                    if ('meteorDependencies' in packageJson && (0, _typeof3.default)(packageJson.meteorDependencies) === 'object') {
                                        plugins += plugin + ', ';
                                        packages.unshift.apply(packages, (0, _toConsumableArray3.default)((0, _keys2.default)(packageJson.meteorDependencies)));
                                        packagesWithVersion.unshift.apply(packagesWithVersion, (0, _toConsumableArray3.default)(packages.map(function (packageName) {
                                            if (packageJson.meteorDependencies[packageName] === '@version') {
                                                return packageName + '@' + packageJson.version;
                                            }
                                            return packageName + '@' + packageJson.meteorDependencies[packageName];
                                        })));
                                    }
                                });

                                if (!(packages.length > 0)) {
                                    _context2.next = 14;
                                    break;
                                }

                                plugins = plugins.substr(0, plugins.length - 2) + ']';
                                _context2.prev = 6;
                                _context2.next = 9;
                                return this.$.meteorApp.ensurePackages(packages, packagesWithVersion, plugins);

                            case 9:
                                _context2.next = 14;
                                break;

                            case 11:
                                _context2.prev = 11;
                                _context2.t0 = _context2['catch'](6);
                                throw new Error(_context2.t0);

                            case 14:
                            case 'end':
                                return _context2.stop();
                        }
                    }
                }, _callee2, this, [[6, 11]]);
            }));

            function ensureMeteorDependencies() {
                return _ref2.apply(this, arguments);
            }

            return ensureMeteorDependencies;
        }()

        /**
         * Builds meteor app.
         */

    }, {
        key: 'getMeteorClientBuild',
        value: function () {
            var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3() {
                return _regenerator2.default.wrap(function _callee3$(_context3) {
                    while (1) {
                        switch (_context3.prev = _context3.next) {
                            case 0:
                                _context3.next = 2;
                                return this.$.meteorApp.build();

                            case 2:
                            case 'end':
                                return _context3.stop();
                        }
                    }
                }, _callee3, this);
            }));

            function getMeteorClientBuild() {
                return _ref3.apply(this, arguments);
            }

            return getMeteorClientBuild;
        }()
    }, {
        key: 'handleTemporaryNodeModules',
        value: function () {
            var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4() {
                return _regenerator2.default.wrap(function _callee4$(_context4) {
                    while (1) {
                        switch (_context4.prev = _context4.next) {
                            case 0:
                                if (!this.$.utils.exists(this.$.env.paths.electronApp.tmpNodeModules)) {
                                    _context4.next = 15;
                                    break;
                                }

                                if (this.$.utils.exists(this.$.env.paths.electronApp.nodeModules)) {
                                    _context4.next = 6;
                                    break;
                                }

                                this.log.debug('moving temp node_modules back');
                                _shelljs2.default.mv(this.$.env.paths.electronApp.tmpNodeModules, this.$.env.paths.electronApp.nodeModules);
                                _context4.next = 15;
                                break;

                            case 6:
                                // If there is a node_modules folder, we should clear the temporary one.
                                this.log.debug('clearing temp node_modules because new one is already created');
                                _context4.prev = 7;
                                _context4.next = 10;
                                return this.$.utils.rmWithRetries('-rf', this.$.env.paths.electronApp.tmpNodeModules);

                            case 10:
                                _context4.next = 15;
                                break;

                            case 12:
                                _context4.prev = 12;
                                _context4.t0 = _context4['catch'](7);
                                throw new Error(_context4.t0);

                            case 15:
                            case 'end':
                                return _context4.stop();
                        }
                    }
                }, _callee4, this, [[7, 12]]);
            }));

            function handleTemporaryNodeModules() {
                return _ref4.apply(this, arguments);
            }

            return handleTemporaryNodeModules;
        }()

        /**
         * Wrapper for spawning npm.
         * @param {Array}  commands - commands for spawn
         * @param {string} stdio
         * @return {Promise}
         */

    }, {
        key: 'runNpm',
        value: function runNpm(commands) {
            var _this4 = this;

            var stdio = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'ignore';

            return new _promise2.default(function (resolve, reject) {
                // TODO: find a way to run npm without depending on it cause it's a huge dependency.
                var npm = _path2.default.join(_this4.$.env.paths.meteorApp.root, 'node_modules', '.bin', 'npm');
                _this4.log.verbose('executing npm ' + commands.join(' '));

                (0, _crossSpawn2.default)(npm, commands, {
                    cwd: _this4.$.env.paths.electronApp.root,
                    stdio: stdio
                }).on('exit', function (code) {
                    return code === 0 ? resolve() : reject('npm exit code was ' + code);
                });
            });
        }

        /**
         * Runs npm link for every package specified in settings.json->linkPackages.
         */

    }, {
        key: 'linkNpmPackages',
        value: function () {
            var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5() {
                var _this5 = this;

                var settings, promises;
                return _regenerator2.default.wrap(function _callee5$(_context5) {
                    while (1) {
                        switch (_context5.prev = _context5.next) {
                            case 0:
                                settings = this.$.desktop.getSettings();
                                promises = [];

                                if ('linkPackages' in this.$.desktop.getSettings()) {
                                    if (Array.isArray(settings.linkPackages)) {
                                        settings.linkPackages.forEach(function (packageName) {
                                            return promises.push(_this5.runNpm(['link', packageName]));
                                        });
                                    }
                                }
                                _context5.next = 5;
                                return _promise2.default.all(promises);

                            case 5:
                            case 'end':
                                return _context5.stop();
                        }
                    }
                }, _callee5, this);
            }));

            function linkNpmPackages() {
                return _ref5.apply(this, arguments);
            }

            return linkNpmPackages;
        }()

        /**
         * Runs npm in the electron app to get the dependencies installed.
         * @returns {Promise}
         */

    }, {
        key: 'ensureDeps',
        value: function () {
            var _ref6 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6() {
                return _regenerator2.default.wrap(function _callee6$(_context6) {
                    while (1) {
                        switch (_context6.prev = _context6.next) {
                            case 0:
                                _context6.next = 2;
                                return this.linkNpmPackages();

                            case 2:

                                this.log.info('installing dependencies');

                                if (!this.$.utils.exists(this.$.env.paths.electronApp.nodeModules)) {
                                    _context6.next = 13;
                                    break;
                                }

                                this.log.debug('running npm prune to wipe unneeded dependencies');
                                _context6.prev = 5;
                                _context6.next = 8;
                                return this.runNpm(['prune']);

                            case 8:
                                _context6.next = 13;
                                break;

                            case 10:
                                _context6.prev = 10;
                                _context6.t0 = _context6['catch'](5);
                                throw new Error(_context6.t0);

                            case 13:
                                _context6.prev = 13;
                                _context6.next = 16;
                                return this.runNpm(['install'], this.$.env.stdio);

                            case 16:
                                _context6.next = 21;
                                break;

                            case 18:
                                _context6.prev = 18;
                                _context6.t1 = _context6['catch'](13);
                                throw new Error(_context6.t1);

                            case 21:
                            case 'end':
                                return _context6.stop();
                        }
                    }
                }, _callee6, this, [[5, 10], [13, 18]]);
            }));

            function ensureDeps() {
                return _ref6.apply(this, arguments);
            }

            return ensureDeps;
        }()

        /**
         * Warns if plugins version are outdated in compare to the newest scaffold.
         * @param {Object} pluginsVersions - current plugins versions from settings.json
         */

    }, {
        key: 'checkPluginsVersion',
        value: function checkPluginsVersion(pluginsVersions) {
            var _this6 = this;

            var settingsJson = JSON.parse(_fs2.default.readFileSync(_path2.default.join(this.$.env.paths.scaffold, 'settings.json')));
            var scaffoldPluginsVersion = this.$.desktop.getDependencies(settingsJson, false).plugins;
            (0, _keys2.default)(pluginsVersions).forEach(function (pluginName) {
                if (pluginName in scaffoldPluginsVersion && scaffoldPluginsVersion[pluginName] !== pluginsVersions[pluginName] && _semver2.default.lt(pluginsVersions[pluginName], scaffoldPluginsVersion[pluginName])) {
                    _this6.log.warn('you are using outdated version ' + pluginsVersions[pluginName] + ' of ' + (pluginName + ', the suggested version to use is ') + ('' + scaffoldPluginsVersion[pluginName]));
                }
            });
        }

        /**
         * Merges core dependency list with the dependencies from .desktop.
         */

    }, {
        key: 'updateDependenciesList',
        value: function updateDependenciesList() {
            var _this7 = this;

            this.log.info('updating list of package.json\'s dependencies');
            var desktopDependencies = this.$.desktop.getDependencies();

            this.checkPluginsVersion(desktopDependencies.plugins);

            this.log.debug('merging settings.json[dependencies]');
            this.depsManager.mergeDependencies('settings.json[dependencies]', desktopDependencies.fromSettings);
            this.log.debug('merging settings.json[plugins]');
            this.depsManager.mergeDependencies('settings.json[plugins]', desktopDependencies.plugins);

            this.log.debug('merging dependencies from modules');
            (0, _keys2.default)(desktopDependencies.modules).forEach(function (module) {
                return _this7.depsManager.mergeDependencies('module[' + module + ']', desktopDependencies.modules[module]);
            });

            this.packageJson.dependencies = this.depsManager.getDependencies();

            this.log.debug('writing updated package.json');
            _fs2.default.writeFileSync(this.$.env.paths.electronApp.packageJson, (0, _stringify2.default)(this.packageJson, null, 2));
        }

        /**
         * Rebuild binary dependencies against Electron's node headers.
         * @returns {Promise}
         */

    }, {
        key: 'rebuildDeps',
        value: function rebuildDeps() {
            if (!this.$.desktop.getSettings().rebuildNativeNodeModules) {
                this.log.warn('native modules rebuild is turned off, be sure to turn it on if you' + ' added any native node ' + 'modules');
                return _promise2.default.resolve();
            }

            this.log.info('issuing native modules rebuild from electron-builder');

            return this.$.electronBuilder.installOrRebuild('x64');
        }

        /**
         * Update package.json fields accordingly to what is set in settings.json.
         *
         * packageJson.name = settings.projectName
         * packageJson.version = settings.version
         * packageJson.* = settings.packageJsonFields
         */

    }, {
        key: 'updatePackageJsonFields',
        value: function updatePackageJsonFields() {
            this.log.verbose('updating package.json fields');
            var settings = this.$.desktop.getSettings();
            /** @type {desktopSettings} */
            var packageJson = this.scaffold.getDefaultPackageJson();

            packageJson.version = settings.version;
            if ('packageJsonFields' in settings) {
                (0, _assignIn2.default)(packageJson, settings.packageJsonFields);
            }
            (0, _assignIn2.default)(packageJson, { name: settings.projectName });

            this.log.debug('writing updated package.json');
            _fs2.default.writeFileSync(this.$.env.paths.electronApp.packageJson, (0, _stringify2.default)(packageJson, null, 4));
            this.packageJson = packageJson;
        }

        /**
         * Updates settings.json with env (prod/dev) information and versions.
         */

    }, {
        key: 'updateSettingsJsonFields',
        value: function updateSettingsJsonFields() {
            this.log.debug('updating settings.json fields');
            var settings = this.$.desktop.getSettings();

            // Save versions.
            settings.desktopVersion = this.$.desktop.getHashVersion();
            settings.compatibilityVersion = this.compatibilityVersion;

            // Pass information about build type to the settings.json.
            settings.env = this.$.env.isProductionBuild() ? 'prod' : 'dev';

            settings.meteorDesktopVersion = this.$.getVersion();

            _fs2.default.writeFileSync(this.$.env.paths.desktopTmp.settings, (0, _stringify2.default)(settings, null, 4));
        }

        /**
         * Copies files from prepared .desktop to desktop.asar in electron app.
         */

    }, {
        key: 'packDesktopToAsar',
        value: function packDesktopToAsar() {
            var _this8 = this;

            this.log.info('packing .desktop to asar');
            return new _promise2.default(function (resolve, reject) {
                _asar2.default.createPackage(_this8.$.env.paths.desktopTmp.root, _this8.$.env.paths.electronApp.desktopAsar, function () {
                    _this8.log.verbose('clearing temporary .desktop');
                    _this8.$.utils.rmWithRetries('-rf', _this8.$.env.paths.desktopTmp.root).then(function () {
                        resolve();
                    }).catch(function (e) {
                        reject(e);
                    });
                });
            });
        }

        /**
         * Makes a temporary copy of .desktop.
         */

    }, {
        key: 'copyDesktopToDesktopTemp',
        value: function copyDesktopToDesktopTemp() {
            this.log.verbose('copying .desktop to temporary location');
            _shelljs2.default.cp('-rf', this.$.env.paths.desktop.root, this.$.env.paths.desktopTmp.root);
            // Remove test files.
            _del2.default.sync([_path2.default.join(this.$.env.paths.desktopTmp.root, '**', '*.test.js')]);
        }

        /**
         * Runs babel and uglify over .desktop if requested.
         */

    }, {
        key: 'transpileAndMinify',
        value: function transpileAndMinify() {
            this.log.info('transpiling and uglifying');

            var settings = this.$.desktop.getSettings();
            var options = 'uglifyOptions' in settings ? settings.uglifyOptions : {};
            options.fromString = true;
            var uglifyingEnabled = 'uglify' in settings && !!settings.uglify;

            // Unfortunately `reify` will not work when we require a .js file from an asar archive.
            // So here we will transpile .desktop to have the ES6 modules working.

            // Uglify does not handle ES6 yet, so we will have to transpile to ES5 for now.
            var preset = uglifyingEnabled && settings.env === 'prod' ? _babelPresetEs2.default : _babelPresetNode2.default;

            _glob2.default.sync(this.$.env.paths.desktopTmp.root + '/**/*.js').forEach(function (file) {
                var _transformFileSync = (0, _babelCore.transformFileSync)(file, {
                    presets: [preset]
                }),
                    code = _transformFileSync.code;

                if (settings.env === 'prod' && uglifyingEnabled) {
                    code = _uglifyJs2.default.minify(code, options).code;
                }
                _fs2.default.writeFileSync(file, code);
            });
        }

        /**
         * Moves all the files that should not be packed into asar into a safe location which is the
         * 'extracted' dir in the electron app.
         */

    }, {
        key: 'excludeFilesFromArchive',
        value: function () {
            var _ref7 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee7() {
                var _this9 = this;

                var configs;
                return _regenerator2.default.wrap(function _callee7$(_context7) {
                    while (1) {
                        switch (_context7.prev = _context7.next) {
                            case 0:
                                this.log.info('excluding files from packing');

                                // Ensure empty `extracted` dir

                                _context7.prev = 1;
                                _context7.next = 4;
                                return this.$.utils.rmWithRetries('-rf', this.$.env.paths.electronApp.extracted);

                            case 4:
                                _context7.next = 9;
                                break;

                            case 6:
                                _context7.prev = 6;
                                _context7.t0 = _context7['catch'](1);
                                throw new Error(_context7.t0);

                            case 9:

                                _shelljs2.default.mkdir(this.$.env.paths.electronApp.extracted);

                                configs = this.$.desktop.gatherModuleConfigs();

                                // Move files that should not be asar'ed.

                                configs.forEach(function (config) {
                                    var moduleConfig = config;
                                    if ('extract' in moduleConfig) {
                                        if (!Array.isArray(moduleConfig.extract)) {
                                            moduleConfig.extract = [moduleConfig.extract];
                                        }
                                        moduleConfig.extract.forEach(function (file) {
                                            _this9.log.debug('excluding ' + file + ' from ' + config.name);
                                            var filePath = _path2.default.join(_this9.$.env.paths.desktopTmp.modules, moduleConfig.dirName, file);
                                            var destinationPath = _path2.default.join(_this9.$.env.paths.electronApp.extracted, moduleConfig.dirName);

                                            if (!_this9.$.utils.exists(destinationPath)) {
                                                _shelljs2.default.mkdir(destinationPath);
                                            }
                                            _shelljs2.default.mv(filePath, destinationPath);
                                        });
                                    }
                                });

                            case 12:
                            case 'end':
                                return _context7.stop();
                        }
                    }
                }, _callee7, this, [[1, 6]]);
            }));

            function excludeFilesFromArchive() {
                return _ref7.apply(this, arguments);
            }

            return excludeFilesFromArchive;
        }()
    }]);
    return ElectronApp;
}();

exports.default = ElectronApp;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9lbGVjdHJvbkFwcC5qcyJdLCJuYW1lcyI6WyJjb25maWciLCJmYXRhbCIsIkVsZWN0cm9uQXBwIiwiJCIsImxvZyIsInNjYWZmb2xkIiwiZGVwc01hbmFnZXIiLCJnZXREZWZhdWx0UGFja2FnZUpzb24iLCJkZXBlbmRlbmNpZXMiLCJtZXRlb3JBcHAiLCJwYWNrYWdlSnNvbiIsInZlcnNpb24iLCJjb21wYXRpYmlsaXR5VmVyc2lvbiIsImV4Y2x1ZGVGcm9tRGVsIiwiaW5mbyIsInJlc29sdmUiLCJkZWJ1ZyIsIm12IiwiZW52IiwicGF0aHMiLCJlbGVjdHJvbkFwcCIsIm5vZGVNb2R1bGVzIiwiam9pbiIsImFwcFJvb3QiLCJjcmVhdGVQYWNrYWdlIiwiYXBwQXNhciIsImV4Y2x1ZGUiLCJzeW5jIiwicm9vdCIsInNlcCIsIm1hcCIsInBhdGhUb0V4Y2x1ZGUiLCJ2ZXJib3NlIiwibWQ1IiwiY3JlYXRlSGFzaCIsImRlcGVuZGVuY3kiLCJtYWluQ29tcGF0aWJpbGl0eVZlcnNpb24iLCJnZXRWZXJzaW9uIiwic3BsaXQiLCJwdXNoIiwiZGVza3RvcENvbXBhdGliaWxpdHlWZXJzaW9uIiwiZGVza3RvcCIsImdldFNldHRpbmdzIiwicHJvY2VzcyIsIk1FVEVPUl9ERVNLVE9QX0RFQlVHX0RFU0tUT1BfQ09NUEFUSUJJTElUWV9WRVJTSU9OIiwiTUVURU9SX0RFU0tUT1BfREVCVUciLCJ1cGRhdGUiLCJkaWdlc3QiLCJydW4iLCJjaGVjayIsIm9wdGlvbnMiLCJlcnJvciIsImV4aXQiLCJ1cGRhdGVHaXRJZ25vcmUiLCJlIiwid2FybiIsInJvb3ROYW1lIiwiZW5zdXJlRGVza3RvcEhDUFBhY2thZ2VzIiwibWFrZSIsInVwZGF0ZVBhY2thZ2VKc29uRmllbGRzIiwidXBkYXRlRGVwZW5kZW5jaWVzTGlzdCIsImNhbGN1bGF0ZUNvbXBhdGliaWxpdHlWZXJzaW9uIiwiaGFuZGxlVGVtcG9yYXJ5Tm9kZU1vZHVsZXMiLCJlbnN1cmVEZXBzIiwiZW5zdXJlTWV0ZW9yRGVwZW5kZW5jaWVzIiwicmVidWlsZERlcHMiLCJpc1Byb2R1Y3Rpb25CdWlsZCIsInBhY2tTa2VsZXRvblRvQXNhciIsImNvcHlEZXNrdG9wVG9EZXNrdG9wVGVtcCIsInVwZGF0ZVNldHRpbmdzSnNvbkZpZWxkcyIsImV4Y2x1ZGVGaWxlc0Zyb21BcmNoaXZlIiwidHJhbnNwaWxlQW5kTWluaWZ5IiwicGFja0Rlc2t0b3BUb0FzYXIiLCJnZXRNZXRlb3JDbGllbnRCdWlsZCIsImVsZWN0cm9uIiwicGFja2FnZXMiLCJwYWNrYWdlc1dpdGhWZXJzaW9uIiwicGx1Z2lucyIsImdldERlcGVuZGVuY2llcyIsImZvckVhY2giLCJwbHVnaW4iLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJtZXRlb3JEZXBlbmRlbmNpZXMiLCJ1bnNoaWZ0IiwicGFja2FnZU5hbWUiLCJsZW5ndGgiLCJzdWJzdHIiLCJlbnN1cmVQYWNrYWdlcyIsIkVycm9yIiwiYnVpbGQiLCJ1dGlscyIsImV4aXN0cyIsInRtcE5vZGVNb2R1bGVzIiwicm1XaXRoUmV0cmllcyIsImNvbW1hbmRzIiwic3RkaW8iLCJyZWplY3QiLCJucG0iLCJjd2QiLCJvbiIsImNvZGUiLCJzZXR0aW5ncyIsInByb21pc2VzIiwiQXJyYXkiLCJpc0FycmF5IiwibGlua1BhY2thZ2VzIiwicnVuTnBtIiwiYWxsIiwibGlua05wbVBhY2thZ2VzIiwicGx1Z2luc1ZlcnNpb25zIiwic2V0dGluZ3NKc29uIiwic2NhZmZvbGRQbHVnaW5zVmVyc2lvbiIsInBsdWdpbk5hbWUiLCJsdCIsImRlc2t0b3BEZXBlbmRlbmNpZXMiLCJjaGVja1BsdWdpbnNWZXJzaW9uIiwibWVyZ2VEZXBlbmRlbmNpZXMiLCJmcm9tU2V0dGluZ3MiLCJtb2R1bGVzIiwibW9kdWxlIiwid3JpdGVGaWxlU3luYyIsInJlYnVpbGROYXRpdmVOb2RlTW9kdWxlcyIsImVsZWN0cm9uQnVpbGRlciIsImluc3RhbGxPclJlYnVpbGQiLCJwYWNrYWdlSnNvbkZpZWxkcyIsIm5hbWUiLCJwcm9qZWN0TmFtZSIsImRlc2t0b3BWZXJzaW9uIiwiZ2V0SGFzaFZlcnNpb24iLCJtZXRlb3JEZXNrdG9wVmVyc2lvbiIsImRlc2t0b3BUbXAiLCJkZXNrdG9wQXNhciIsInRoZW4iLCJjYXRjaCIsImNwIiwidWdsaWZ5T3B0aW9ucyIsImZyb21TdHJpbmciLCJ1Z2xpZnlpbmdFbmFibGVkIiwidWdsaWZ5IiwicHJlc2V0IiwiZmlsZSIsInByZXNldHMiLCJtaW5pZnkiLCJleHRyYWN0ZWQiLCJta2RpciIsImNvbmZpZ3MiLCJnYXRoZXJNb2R1bGVDb25maWdzIiwibW9kdWxlQ29uZmlnIiwiZXh0cmFjdCIsImZpbGVQYXRoIiwiZGlyTmFtZSIsImRlc3RpbmF0aW9uUGF0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUdBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsa0JBQU1BLE1BQU4sQ0FBYUMsS0FBYixHQUFxQixJQUFyQjs7QUFFQTs7Ozs7SUFJcUJDLFc7O0FBRWpCOzs7O0FBSUEseUJBQVlDLENBQVosRUFBZTtBQUFBOztBQUNYLGFBQUtDLEdBQUwsR0FBVyxrQkFBUSxhQUFSLENBQVg7QUFDQSxhQUFLQyxRQUFMLEdBQWdCLGtDQUF3QkYsQ0FBeEIsQ0FBaEI7QUFDQSxhQUFLRyxXQUFMLEdBQW1CLGtDQUNmSCxDQURlLEVBRWYsS0FBS0UsUUFBTCxDQUFjRSxxQkFBZCxHQUFzQ0MsWUFGdkIsQ0FBbkI7QUFJQSxhQUFLTCxDQUFMLEdBQVNBLENBQVQ7QUFDQSxhQUFLTSxTQUFMLEdBQWlCLEtBQUtOLENBQUwsQ0FBT00sU0FBeEI7QUFDQSxhQUFLQyxXQUFMLEdBQW1CLElBQW5CO0FBQ0Es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QUtuSSxJQUFMLENBQ3BCLE9BQUtuQixDQUFMLENBQU9lLEdBQVAsQ0FBV0MsS0FBWCxDQUFpQkMsV0FBakIsQ0FBNkI2SCxTQURULEVBQ29CSSxhQUFhRyxPQURqQyxDQUF4Qjs7QUFHQSxnREFBSSxDQUFDLE9BQUtySixDQUFMLENBQU95RixLQUFQLENBQWFDLE1BQWIsQ0FBb0I0RCxlQUFwQixDQUFMLEVBQTJDO0FBQ3ZDLGtFQUFNUCxLQUFOLENBQVlPLGVBQVo7QUFDSDtBQUNELDhEQUFNeEksRUFBTixDQUFTc0ksUUFBVCxFQUFtQkUsZUFBbkI7QUFDSCx5Q0FYRDtBQVlIO0FBQ0osaUNBbkJEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztrQkF4a0JhdkosVyIsImZpbGUiOiJlbGVjdHJvbkFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhc2FyIGZyb20gJ2FzYXInO1xuaW1wb3J0IGFzc2lnbkluIGZyb20gJ2xvZGFzaC9hc3NpZ25Jbic7XG5pbXBvcnQgeyB0cmFuc2Zvcm1GaWxlU3luYyB9IGZyb20gJ2JhYmVsLWNvcmUnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IGRlbCBmcm9tICdkZWwnO1xuaW1wb3J0IGVzMjAxNVByZXNldCBmcm9tICdiYWJlbC1wcmVzZXQtZXMyMDE1JztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBub2RlNlByZXNldCBmcm9tICdiYWJlbC1wcmVzZXQtbm9kZTYnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc2hlbGwgZnJvbSAnc2hlbGxqcyc7XG5pbXBvcnQgc3Bhd24gZnJvbSAnY3Jvc3Mtc3Bhd24nO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IHVnbGlmeSBmcm9tICd1Z2xpZnktanMnO1xuXG5cbmltcG9ydCBMb2cgZnJvbSAnLi9sb2cnO1xuaW1wb3J0IEVsZWN0cm9uQXBwU2NhZmZvbGQgZnJvbSAnLi9lbGVjdHJvbkFwcFNjYWZmb2xkJztcbmltcG9ydCBEZXBlbmRlbmNpZXNNYW5hZ2VyIGZyb20gJy4vZGVwZW5kZW5jaWVzTWFuYWdlcic7XG5cbnNoZWxsLmNvbmZpZy5mYXRhbCA9IHRydWU7XG5cbi8qKlxuICogUmVwcmVzZW50cyB0aGUgLmRlc2t0b3AgZGlyIHNjYWZmb2xkLlxuICogQGNsYXNzXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVsZWN0cm9uQXBwIHtcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7TWV0ZW9yRGVza3RvcH0gJCAtIGNvbnRleHRcbiAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigkKSB7XG4gICAgICAgIHRoaXMubG9nID0gbmV3IExvZygnZWxlY3Ryb25BcHAnKTtcbiAgICAgICAgdGhpcy5zY2FmZm9sZCA9IG5ldyBFbGVjdHJvbkFwcFNjYWZmb2xkKCQpO1xuICAgICAgICB0aGlzLmRlcHNNYW5hZ2VyID0gbmV3IERlcGVuZGVuY2llc01hbmFnZXIoXG4gICAgICAgICAgICAkLFxuICAgICAgICAgICAgdGhpcy5zY2FmZm9sZC5nZXREZWZhdWx0UGFja2FnZUpzb24oKS5kZXBlbmRlbmNpZXNcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy4kID0gJDtcbiAgICAgICAgdGhpcy5tZXRlb3JBcHAgPSB0aGlzLiQubWV0ZW9yQXBwO1xuICAgICAgICB0aGlzLnBhY2thZ2VKc29uID0gbnVsbDtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gbnVsbDtcbiAgICAgICAgdGhpcy5jb21wYXRpYmlsaXR5VmVyc2lvbiA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZXMgYW4gYXBwLmFzYXIgZnJvbSB0aGUgc2tlbGV0b24gYXBwLlxuICAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IGV4Y2x1ZGVGcm9tRGVsIC0gbGlzdCBvZiBwYXRocyB0byBleGNsdWRlIGZyb20gZGVsZXRpbmdcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBwYWNrU2tlbGV0b25Ub0FzYXIoZXhjbHVkZUZyb21EZWwgPSBbXSkge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKCdwYWNraW5nIHNrZWxldG9uIGFwcCBhbmQgbm9kZV9tb2R1bGVzIHRvIGFzYXIgYXJjaGl2ZScpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gcGFjayBza2VsZXRvbiBhcHAgYW5kIG5vZGVfbW9kdWxlcyB0b2dldGhlciwgc28gd2UgbmVlZCB0byB0ZW1wb3JhcmlseVxuICAgICAgICAgICAgLy8gbW92ZSBub2RlX21vZHVsZXMgdG8gYXBwIGRpci5cbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdtb3Zpbmcgbm9kZV9tb2R1bGVzIHRvIGFwcCBkaXInKTtcbiAgICAgICAgICAgIHNoZWxsLm12KFxuICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAubm9kZU1vZHVsZXMsXG4gICAgICAgICAgICAgICAgcGF0aC5qb2luKHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAuYXBwUm9vdCwgJ25vZGVfbW9kdWxlcycpXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ3BhY2tpbmcnKTtcbiAgICAgICAgICAgIGFzYXIuY3JlYXRlUGFja2FnZShcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLmFwcFJvb3QsXG4gICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5hcHBBc2FyLFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gTGV0cyBtb3ZlIHRoZSBub2RlX21vZHVsZXMgYmFjay5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ21vdmluZyBub2RlX21vZHVsZXMgYmFjayBmcm9tIGFwcCBkaXInKTtcbiAgICAgICAgICAgICAgICAgICAgc2hlbGwubXYoXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXRoLmpvaW4odGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5hcHBSb290LCAnbm9kZV9tb2R1bGVzJyksXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdkZWxldGluZyBzb3VyY2UgZmlsZXMnKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhjbHVkZSA9IEFycmF5LmNvbmNhdChbXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5hcHBBc2FyLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5wYWNrYWdlSnNvblxuICAgICAgICAgICAgICAgICAgICBdLCBleGNsdWRlRnJvbURlbCk7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVsLnN5bmMoXG4gICAgICAgICAgICAgICAgICAgICAgICBBcnJheS5jb25jYXQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgW2Ake3RoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAucm9vdH0ke3BhdGguc2VwfSpgXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNsdWRlLm1hcChwYXRoVG9FeGNsdWRlID0+IGAhJHtwYXRoVG9FeGNsdWRlfWApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGVzIGEgbWQ1IGZyb20gYWxsIGRlcGVuZGVuY2llcy5cbiAgICAgKi9cbiAgICBjYWxjdWxhdGVDb21wYXRpYmlsaXR5VmVyc2lvbigpIHtcbiAgICAgICAgdGhpcy5sb2cudmVyYm9zZSgnY2FsY3VsYXRpbmcgY29tcGF0aWJpbGl0eSB2ZXJzaW9uJyk7XG4gICAgICAgIGNvbnN0IG1kNSA9IGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKTtcbiAgICAgICAgbGV0IGRlcGVuZGVuY2llcyA9IEFycmF5LnNvcnQoT2JqZWN0LmtleXModGhpcy5wYWNrYWdlSnNvbi5kZXBlbmRlbmNpZXMpKTtcbiAgICAgICAgZGVwZW5kZW5jaWVzID0gZGVwZW5kZW5jaWVzLm1hcChkZXBlbmRlbmN5ID0+XG4gICAgICAgICAgICBgJHtkZXBlbmRlbmN5fToke3RoaXMucGFja2FnZUpzb24uZGVwZW5kZW5jaWVzW2RlcGVuZGVuY3ldfWBcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgbWFpbkNvbXBhdGliaWxpdHlWZXJzaW9uID0gdGhpcy4kLmdldFZlcnNpb24oKS5zcGxpdCgnLicpO1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbWV0ZW9yLWRlc2t0b3AgY29tcGF0aWJpbGl0eSB2ZXJzaW9uIGlzICcsXG4gICAgICAgICAgICBgJHttYWluQ29tcGF0aWJpbGl0eVZlcnNpb25bMF19LiR7bWFpbkNvbXBhdGliaWxpdHlWZXJzaW9uWzFdfWApO1xuICAgICAgICBkZXBlbmRlbmNpZXMucHVzaChcbiAgICAgICAgICAgIGBtZXRlb3ItZGVza3RvcDoke21haW5Db21wYXRpYmlsaXR5VmVyc2lvblswXX0uJHttYWluQ29tcGF0aWJpbGl0eVZlcnNpb25bMV19YCk7XG5cbiAgICAgICAgY29uc3QgZGVza3RvcENvbXBhdGliaWxpdHlWZXJzaW9uID0gdGhpcy4kLmRlc2t0b3AuZ2V0U2V0dGluZ3MoKS52ZXJzaW9uLnNwbGl0KCcuJylbMF07XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCcuZGVza3RvcCBjb21wYXRpYmlsaXR5IHZlcnNpb24gaXMgJywgZGVza3RvcENvbXBhdGliaWxpdHlWZXJzaW9uKTtcbiAgICAgICAgZGVwZW5kZW5jaWVzLnB1c2goXG4gICAgICAgICAgICBgZGVza3RvcC1hcHA6JHtkZXNrdG9wQ29tcGF0aWJpbGl0eVZlcnNpb259YCk7XG5cbiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk1FVEVPUl9ERVNLVE9QX0RFQlVHX0RFU0tUT1BfQ09NUEFUSUJJTElUWV9WRVJTSU9OIHx8XG4gICAgICAgICAgICBwcm9jZXNzLmVudi5NRVRFT1JfREVTS1RPUF9ERUJVR1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGBjb21wYXRpYmlsaXR5IHZlcnNpb24gY2FsY3VsYXRlZCBmcm9tICR7SlNPTi5zdHJpbmdpZnkoZGVwZW5kZW5jaWVzKX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG1kNS51cGRhdGUoSlNPTi5zdHJpbmdpZnkoZGVwZW5kZW5jaWVzKSk7XG4gICAgICAgIHRoaXMuY29tcGF0aWJpbGl0eVZlcnNpb24gPSBtZDUuZGlnZXN0KCdoZXgnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW5zIGFsbCBuZWNlc3NhcnkgdGFza3MgdG8gYnVpbGQgdGhlIGRlc2t0b3BpZmllZCBhcHAuXG4gICAgICovXG4gICAgYXN5bmMgYnVpbGQocnVuID0gZmFsc2UpIHtcbiAgICAgICAgLy8gVE9ETzogcmVmYWN0b3IgdG8gYSB0YXNrIHJ1bm5lclxuICAgICAgICB0aGlzLmxvZy5pbmZvKCdzY2FmZm9sZGluZycpO1xuXG4gICAgICAgIGlmICghdGhpcy4kLmRlc2t0b3AuY2hlY2soKSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLiQuZW52Lm9wdGlvbnMuc2NhZmZvbGQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignc2VlbXMgdGhhdCB5b3UgZG8gbm90IGhhdmUgYSAuZGVza3RvcCBkaXIgaW4geW91ciBwcm9qZWN0IG9yIGl0IGlzJyArXG4gICAgICAgICAgICAgICAgICAgICcgY29ycnVwdGVkLiBSdW4gXFwnbnBtIHJ1biBkZXNrdG9wIC0tIGluaXRcXCcgdG8gZ2V0IGEgbmV3IG9uZS4nKTtcbiAgICAgICAgICAgICAgICAvLyBEbyBub3QgZmFpbCwgc28gdGhhdCBucG0gd2lsbCBub3QgcHJpbnQgaGlzIGVycm9yIHN0dWZmIHRvIGNvbnNvbGUuXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLiQuZGVza3RvcC5zY2FmZm9sZCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuJC5tZXRlb3JBcHAudXBkYXRlR2l0SWdub3JlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy4kLm1ldGVvckFwcC51cGRhdGVHaXRJZ25vcmUoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cud2FybihgZXJyb3Igb2NjdXJyZWQgd2hpbGUgYWRkaW5nICR7dGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5yb290TmFtZX1gICtcbiAgICAgICAgICAgICAgICAndG8gLmdpdGlnbm9yZTogJywgZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy4kLm1ldGVvckFwcC5lbnN1cmVEZXNrdG9wSENQUGFja2FnZXMoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIHdoaWxlIGNoZWNraW5nIGZvciByZXF1aXJlZCBwYWNrYWdlczogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zY2FmZm9sZC5tYWtlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBzY2FmZm9sZGluZzogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVQYWNrYWdlSnNvbkZpZWxkcygpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgdXBkYXRpbmcgcGFja2FnZS5qc29uOiAnLCBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZURlcGVuZGVuY2llc0xpc3QoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIHdoaWxlIG1lcmdpbmcgZGVwZW5kZW5jaWVzIGxpc3Q6ICcsIGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlQ29tcGF0aWJpbGl0eVZlcnNpb24oKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIHdoaWxlIGNhbGN1bGF0aW5nIGNvbXBhdGliaWxpdHkgdmVyc2lvbjogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgYSB0ZW1wb3Jhcnkgbm9kZV9tb2R1bGVzIGZvbGRlciBhbmQgbm8gbm9kZV9tb2R1bGVzIGZvbGRlciwgd2Ugd2lsbFxuICAgICAgICAgICAgLy8gcmVzdG9yZSBpdCwgYXMgaXQgbWlnaHQgYmUgYSBsZWZ0b3ZlciBmcm9tIGFuIGludGVycnVwdGVkIGZsb3cuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVRlbXBvcmFyeU5vZGVNb2R1bGVzKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciBvY2N1cnJlZCB3aGlsZSBoYW5kbGluZyB0ZW1wb3Jhcnkgbm9kZV9tb2R1bGVzOiAnLCBlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVuc3VyZURlcHMoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIG9jY3VycmVkIHdoaWxlIHJ1bm5pbmcgbnBtOiAnLCBlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVuc3VyZU1ldGVvckRlcGVuZGVuY2llcygpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igb2NjdXJyZWQgd2hpbGUgcnVubmluZyBucG06ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucmVidWlsZERlcHMoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIG9jY3VycmVkIHdoaWxlIHJlYnVpbGRpbmcgbmF0aXZlIG5vZGUgbW9kdWxlczogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy4kLmVudi5pc1Byb2R1Y3Rpb25CdWlsZCgpKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGFja1NrZWxldG9uVG9Bc2FyKCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIHdoaWxlIHBhY2tpbmcgc2tlbGV0b24gdG8gYXNhcjogJywgZSk7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETzogZmluZCBhIHdheSB0byBhdm9pZCBjb3B5aW5nIC5kZXNrdG9wIHRvIGEgdGVtcCBsb2NhdGlvblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5jb3B5RGVza3RvcFRvRGVza3RvcFRlbXAoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIHdoaWxlIGNvcHlpbmcgLmRlc2t0b3AgdG8gYSB0ZW1wb3JhcnkgbG9jYXRpb246ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU2V0dGluZ3NKc29uRmllbGRzKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSB1cGRhdGluZyBzZXR0aW5ncy5qc29uOiAnLCBlKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmV4Y2x1ZGVGaWxlc0Zyb21BcmNoaXZlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBleGNsdWRpbmcgZmlsZXMgZnJvbSBwYWNraW5nIHRvIGFzYXI6ICcsIGUpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMudHJhbnNwaWxlQW5kTWluaWZ5KCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSB0cmFuc3BpbGluZyBvciBtaW5pZnlpbmc6ICcsIGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucGFja0Rlc2t0b3BUb0FzYXIoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoJ2Vycm9yIG9jY3VycmVkIHdoaWxlIHBhY2tpbmcgLmRlc2t0b3AgdG8gYXNhcjogJywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5nZXRNZXRlb3JDbGllbnRCdWlsZCgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGdldHRpbmcgbWV0ZW9yIG1vYmlsZSBidWlsZDogJywgZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocnVuKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5pbmZvKCdydW5uaW5nJyk7XG4gICAgICAgICAgICB0aGlzLiQuZWxlY3Ryb24ucnVuKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5pbmZvKCdidWlsdCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRW5zdXJlcyBhbGwgcmVxdWlyZWQgZGVwZW5kZW5jaWVzIGFyZSBhZGRlZCB0byB0aGUgTWV0ZW9yIHByb2plY3QuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPHZvaWQ+fVxuICAgICAqL1xuICAgIGFzeW5jIGVuc3VyZU1ldGVvckRlcGVuZGVuY2llcygpIHtcbiAgICAgICAgY29uc3QgcGFja2FnZXMgPSBbXTtcbiAgICAgICAgY29uc3QgcGFja2FnZXNXaXRoVmVyc2lvbiA9IFtdO1xuICAgICAgICBsZXQgcGx1Z2lucyA9ICdwbHVnaW5zIFsnO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMuJC5kZXNrdG9wLmdldERlcGVuZGVuY2llcygpLnBsdWdpbnMpLmZvckVhY2goKHBsdWdpbikgPT4ge1xuICAgICAgICAgICAgLy8gUmVhZCBwYWNrYWdlLmpzb24gb2YgdGhlIHBsdWdpbi5cbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID1cbiAgICAgICAgICAgICAgICBKU09OLnBhcnNlKFxuICAgICAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZVN5bmMoXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXRoLmpvaW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcywgcGx1Z2luLCAncGFja2FnZS5qc29uJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAndXRmOCdcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmICgnbWV0ZW9yRGVwZW5kZW5jaWVzJyBpbiBwYWNrYWdlSnNvbiAmJiB0eXBlb2YgcGFja2FnZUpzb24ubWV0ZW9yRGVwZW5kZW5jaWVzID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIHBsdWdpbnMgKz0gYCR7cGx1Z2lufSwgYDtcbiAgICAgICAgICAgICAgICBwYWNrYWdlcy51bnNoaWZ0KC4uLk9iamVjdC5rZXlzKHBhY2thZ2VKc29uLm1ldGVvckRlcGVuZGVuY2llcykpO1xuICAgICAgICAgICAgICAgIHBhY2thZ2VzV2l0aFZlcnNpb24udW5zaGlmdCguLi5wYWNrYWdlcy5tYXAoKHBhY2thZ2VOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWNrYWdlSnNvbi5tZXRlb3JEZXBlbmRlbmNpZXNbcGFja2FnZU5hbWVdID09PSAnQHZlcnNpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7cGFja2FnZU5hbWV9QCR7cGFja2FnZUpzb24udmVyc2lvbn1gO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtwYWNrYWdlTmFtZX1AJHtwYWNrYWdlSnNvbi5tZXRlb3JEZXBlbmRlbmNpZXNbcGFja2FnZU5hbWVdfWA7XG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAocGFja2FnZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcGx1Z2lucyA9IGAke3BsdWdpbnMuc3Vic3RyKDAsIHBsdWdpbnMubGVuZ3RoIC0gMil9XWA7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuJC5tZXRlb3JBcHAuZW5zdXJlUGFja2FnZXMocGFja2FnZXMsIHBhY2thZ2VzV2l0aFZlcnNpb24sIHBsdWdpbnMpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkcyBtZXRlb3IgYXBwLlxuICAgICAqL1xuICAgIGFzeW5jIGdldE1ldGVvckNsaWVudEJ1aWxkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLiQubWV0ZW9yQXBwLmJ1aWxkKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgaGFuZGxlVGVtcG9yYXJ5Tm9kZU1vZHVsZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLiQudXRpbHMuZXhpc3RzKHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAudG1wTm9kZU1vZHVsZXMpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbW92aW5nIHRlbXAgbm9kZV9tb2R1bGVzIGJhY2snKTtcbiAgICAgICAgICAgICAgICBzaGVsbC5tdihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC50bXBOb2RlTW9kdWxlcyxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlc1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGEgbm9kZV9tb2R1bGVzIGZvbGRlciwgd2Ugc2hvdWxkIGNsZWFyIHRoZSB0ZW1wb3Jhcnkgb25lLlxuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdjbGVhcmluZyB0ZW1wIG5vZGVfbW9kdWxlcyBiZWNhdXNlIG5ldyBvbmUgaXMgYWxyZWFkeSBjcmVhdGVkJyk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy4kLnV0aWxzLnJtV2l0aFJldHJpZXMoXG4gICAgICAgICAgICAgICAgICAgICAgICAnLXJmJywgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC50bXBOb2RlTW9kdWxlcyk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogV3JhcHBlciBmb3Igc3Bhd25pbmcgbnBtLlxuICAgICAqIEBwYXJhbSB7QXJyYXl9ICBjb21tYW5kcyAtIGNvbW1hbmRzIGZvciBzcGF3blxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGRpb1xuICAgICAqIEByZXR1cm4ge1Byb21pc2V9XG4gICAgICovXG4gICAgcnVuTnBtKGNvbW1hbmRzLCBzdGRpbyA9ICdpZ25vcmUnKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAvLyBUT0RPOiBmaW5kIGEgd2F5IHRvIHJ1biBucG0gd2l0aG91dCBkZXBlbmRpbmcgb24gaXQgY2F1c2UgaXQncyBhIGh1Z2UgZGVwZW5kZW5jeS5cbiAgICAgICAgICAgIGNvbnN0IG5wbSA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLm1ldGVvckFwcC5yb290LCAnbm9kZV9tb2R1bGVzJywgJy5iaW4nLCAnbnBtJyk7XG4gICAgICAgICAgICB0aGlzLmxvZy52ZXJib3NlKGBleGVjdXRpbmcgbnBtICR7Y29tbWFuZHMuam9pbignICcpfWApO1xuXG4gICAgICAgICAgICBzcGF3bihucG0sIGNvbW1hbmRzLCB7XG4gICAgICAgICAgICAgICAgY3dkOiB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnJvb3QsXG4gICAgICAgICAgICAgICAgc3RkaW9cbiAgICAgICAgICAgIH0pLm9uKCdleGl0JywgY29kZSA9PiAoXG4gICAgICAgICAgICAgICAgICAgIChjb2RlID09PSAwKSA/IHJlc29sdmUoKSA6IHJlamVjdChgbnBtIGV4aXQgY29kZSB3YXMgJHtjb2RlfWApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBSdW5zIG5wbSBsaW5rIGZvciBldmVyeSBwYWNrYWdlIHNwZWNpZmllZCBpbiBzZXR0aW5ncy5qc29uLT5saW5rUGFja2FnZXMuXG4gICAgICovXG4gICAgYXN5bmMgbGlua05wbVBhY2thZ2VzKCkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCk7XG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgICAgIGlmICgnbGlua1BhY2thZ2VzJyBpbiB0aGlzLiQuZGVza3RvcC5nZXRTZXR0aW5ncygpKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZXR0aW5ncy5saW5rUGFja2FnZXMpKSB7XG4gICAgICAgICAgICAgICAgc2V0dGluZ3MubGlua1BhY2thZ2VzLmZvckVhY2gocGFja2FnZU5hbWUgPT5cbiAgICAgICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnJ1bk5wbShbJ2xpbmsnLCBwYWNrYWdlTmFtZV0pKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJ1bnMgbnBtIGluIHRoZSBlbGVjdHJvbiBhcHAgdG8gZ2V0IHRoZSBkZXBlbmRlbmNpZXMgaW5zdGFsbGVkLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIGFzeW5jIGVuc3VyZURlcHMoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubGlua05wbVBhY2thZ2VzKCk7XG5cbiAgICAgICAgdGhpcy5sb2cuaW5mbygnaW5zdGFsbGluZyBkZXBlbmRlbmNpZXMnKTtcbiAgICAgICAgaWYgKHRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcykpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdydW5uaW5nIG5wbSBwcnVuZSB0byB3aXBlIHVubmVlZGVkIGRlcGVuZGVuY2llcycpO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnJ1bk5wbShbJ3BydW5lJ10pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5ydW5OcG0oWydpbnN0YWxsJ10sIHRoaXMuJC5lbnYuc3RkaW8pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXYXJucyBpZiBwbHVnaW5zIHZlcnNpb24gYXJlIG91dGRhdGVkIGluIGNvbXBhcmUgdG8gdGhlIG5ld2VzdCBzY2FmZm9sZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGx1Z2luc1ZlcnNpb25zIC0gY3VycmVudCBwbHVnaW5zIHZlcnNpb25zIGZyb20gc2V0dGluZ3MuanNvblxuICAgICAqL1xuICAgIGNoZWNrUGx1Z2luc1ZlcnNpb24ocGx1Z2luc1ZlcnNpb25zKSB7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzSnNvbiA9IEpTT04ucGFyc2UoXG4gICAgICAgICAgICBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKHRoaXMuJC5lbnYucGF0aHMuc2NhZmZvbGQsICdzZXR0aW5ncy5qc29uJykpXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHNjYWZmb2xkUGx1Z2luc1ZlcnNpb24gPSB0aGlzLiQuZGVza3RvcC5nZXREZXBlbmRlbmNpZXMoc2V0dGluZ3NKc29uLCBmYWxzZSkucGx1Z2lucztcbiAgICAgICAgT2JqZWN0LmtleXMocGx1Z2luc1ZlcnNpb25zKS5mb3JFYWNoKChwbHVnaW5OYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAocGx1Z2luTmFtZSBpbiBzY2FmZm9sZFBsdWdpbnNWZXJzaW9uICYmXG4gICAgICAgICAgICAgICAgc2NhZmZvbGRQbHVnaW5zVmVyc2lvbltwbHVnaW5OYW1lXSAhPT0gcGx1Z2luc1ZlcnNpb25zW3BsdWdpbk5hbWVdICYmXG4gICAgICAgICAgICAgICAgc2VtdmVyLmx0KHBsdWdpbnNWZXJzaW9uc1twbHVnaW5OYW1lXSwgc2NhZmZvbGRQbHVnaW5zVmVyc2lvbltwbHVnaW5OYW1lXSlcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLndhcm4oYHlvdSBhcmUgdXNpbmcgb3V0ZGF0ZWQgdmVyc2lvbiAke3BsdWdpbnNWZXJzaW9uc1twbHVnaW5OYW1lXX0gb2YgYCArXG4gICAgICAgICAgICAgICAgICAgIGAke3BsdWdpbk5hbWV9LCB0aGUgc3VnZ2VzdGVkIHZlcnNpb24gdG8gdXNlIGlzIGAgK1xuICAgICAgICAgICAgICAgICAgICBgJHtzY2FmZm9sZFBsdWdpbnNWZXJzaW9uW3BsdWdpbk5hbWVdfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNZXJnZXMgY29yZSBkZXBlbmRlbmN5IGxpc3Qgd2l0aCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gLmRlc2t0b3AuXG4gICAgICovXG4gICAgdXBkYXRlRGVwZW5kZW5jaWVzTGlzdCgpIHtcbiAgICAgICAgdGhpcy5sb2cuaW5mbygndXBkYXRpbmcgbGlzdCBvZiBwYWNrYWdlLmpzb25cXCdzIGRlcGVuZGVuY2llcycpO1xuICAgICAgICBjb25zdCBkZXNrdG9wRGVwZW5kZW5jaWVzID0gdGhpcy4kLmRlc2t0b3AuZ2V0RGVwZW5kZW5jaWVzKCk7XG5cbiAgICAgICAgdGhpcy5jaGVja1BsdWdpbnNWZXJzaW9uKGRlc2t0b3BEZXBlbmRlbmNpZXMucGx1Z2lucyk7XG5cbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ21lcmdpbmcgc2V0dGluZ3MuanNvbltkZXBlbmRlbmNpZXNdJyk7XG4gICAgICAgIHRoaXMuZGVwc01hbmFnZXIubWVyZ2VEZXBlbmRlbmNpZXMoXG4gICAgICAgICAgICAnc2V0dGluZ3MuanNvbltkZXBlbmRlbmNpZXNdJyxcbiAgICAgICAgICAgIGRlc2t0b3BEZXBlbmRlbmNpZXMuZnJvbVNldHRpbmdzXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdtZXJnaW5nIHNldHRpbmdzLmpzb25bcGx1Z2luc10nKTtcbiAgICAgICAgdGhpcy5kZXBzTWFuYWdlci5tZXJnZURlcGVuZGVuY2llcyhcbiAgICAgICAgICAgICdzZXR0aW5ncy5qc29uW3BsdWdpbnNdJyxcbiAgICAgICAgICAgIGRlc2t0b3BEZXBlbmRlbmNpZXMucGx1Z2luc1xuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdtZXJnaW5nIGRlcGVuZGVuY2llcyBmcm9tIG1vZHVsZXMnKTtcbiAgICAgICAgT2JqZWN0LmtleXMoZGVza3RvcERlcGVuZGVuY2llcy5tb2R1bGVzKS5mb3JFYWNoKG1vZHVsZSA9PlxuICAgICAgICAgICAgdGhpcy5kZXBzTWFuYWdlci5tZXJnZURlcGVuZGVuY2llcyhcbiAgICAgICAgICAgICAgICBgbW9kdWxlWyR7bW9kdWxlfV1gLFxuICAgICAgICAgICAgICAgIGRlc2t0b3BEZXBlbmRlbmNpZXMubW9kdWxlc1ttb2R1bGVdXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5wYWNrYWdlSnNvbi5kZXBlbmRlbmNpZXMgPSB0aGlzLmRlcHNNYW5hZ2VyLmdldERlcGVuZGVuY2llcygpO1xuXG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCd3cml0aW5nIHVwZGF0ZWQgcGFja2FnZS5qc29uJyk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnBhY2thZ2VKc29uLCBKU09OLnN0cmluZ2lmeSh0aGlzLnBhY2thZ2VKc29uLCBudWxsLCAyKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlYnVpbGQgYmluYXJ5IGRlcGVuZGVuY2llcyBhZ2FpbnN0IEVsZWN0cm9uJ3Mgbm9kZSBoZWFkZXJzLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIHJlYnVpbGREZXBzKCkge1xuICAgICAgICBpZiAoIXRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCkucmVidWlsZE5hdGl2ZU5vZGVNb2R1bGVzKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy53YXJuKCduYXRpdmUgbW9kdWxlcyByZWJ1aWxkIGlzIHR1cm5lZCBvZmYsIGJlIHN1cmUgdG8gdHVybiBpdCBvbiBpZiB5b3UnICtcbiAgICAgICAgICAgICAgICAnIGFkZGVkIGFueSBuYXRpdmUgbm9kZSAnICtcbiAgICAgICAgICAgICAgICAnbW9kdWxlcycpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2cuaW5mbygnaXNzdWluZyBuYXRpdmUgbW9kdWxlcyByZWJ1aWxkIGZyb20gZWxlY3Ryb24tYnVpbGRlcicpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLiQuZWxlY3Ryb25CdWlsZGVyLmluc3RhbGxPclJlYnVpbGQoJ3g2NCcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBwYWNrYWdlLmpzb24gZmllbGRzIGFjY29yZGluZ2x5IHRvIHdoYXQgaXMgc2V0IGluIHNldHRpbmdzLmpzb24uXG4gICAgICpcbiAgICAgKiBwYWNrYWdlSnNvbi5uYW1lID0gc2V0dGluZ3MucHJvamVjdE5hbWVcbiAgICAgKiBwYWNrYWdlSnNvbi52ZXJzaW9uID0gc2V0dGluZ3MudmVyc2lvblxuICAgICAqIHBhY2thZ2VKc29uLiogPSBzZXR0aW5ncy5wYWNrYWdlSnNvbkZpZWxkc1xuICAgICAqL1xuICAgIHVwZGF0ZVBhY2thZ2VKc29uRmllbGRzKCkge1xuICAgICAgICB0aGlzLmxvZy52ZXJib3NlKCd1cGRhdGluZyBwYWNrYWdlLmpzb24gZmllbGRzJyk7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy4kLmRlc2t0b3AuZ2V0U2V0dGluZ3MoKTtcbiAgICAgICAgLyoqIEB0eXBlIHtkZXNrdG9wU2V0dGluZ3N9ICovXG4gICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gdGhpcy5zY2FmZm9sZC5nZXREZWZhdWx0UGFja2FnZUpzb24oKTtcblxuICAgICAgICBwYWNrYWdlSnNvbi52ZXJzaW9uID0gc2V0dGluZ3MudmVyc2lvbjtcbiAgICAgICAgaWYgKCdwYWNrYWdlSnNvbkZpZWxkcycgaW4gc2V0dGluZ3MpIHtcbiAgICAgICAgICAgIGFzc2lnbkluKHBhY2thZ2VKc29uLCBzZXR0aW5ncy5wYWNrYWdlSnNvbkZpZWxkcyk7XG4gICAgICAgIH1cbiAgICAgICAgYXNzaWduSW4ocGFja2FnZUpzb24sIHsgbmFtZTogc2V0dGluZ3MucHJvamVjdE5hbWUgfSk7XG5cbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ3dyaXRpbmcgdXBkYXRlZCBwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAucGFja2FnZUpzb24sIEpTT04uc3RyaW5naWZ5KHBhY2thZ2VKc29uLCBudWxsLCA0KVxuICAgICAgICApO1xuICAgICAgICB0aGlzLnBhY2thZ2VKc29uID0gcGFja2FnZUpzb247XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyBzZXR0aW5ncy5qc29uIHdpdGggZW52IChwcm9kL2RldikgaW5mb3JtYXRpb24gYW5kIHZlcnNpb25zLlxuICAgICAqL1xuICAgIHVwZGF0ZVNldHRpbmdzSnNvbkZpZWxkcygpIHtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ3VwZGF0aW5nIHNldHRpbmdzLmpzb24gZmllbGRzJyk7XG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy4kLmRlc2t0b3AuZ2V0U2V0dGluZ3MoKTtcblxuICAgICAgICAvLyBTYXZlIHZlcnNpb25zLlxuICAgICAgICBzZXR0aW5ncy5kZXNrdG9wVmVyc2lvbiA9IHRoaXMuJC5kZXNrdG9wLmdldEhhc2hWZXJzaW9uKCk7XG4gICAgICAgIHNldHRpbmdzLmNvbXBhdGliaWxpdHlWZXJzaW9uID0gdGhpcy5jb21wYXRpYmlsaXR5VmVyc2lvbjtcblxuICAgICAgICAvLyBQYXNzIGluZm9ybWF0aW9uIGFib3V0IGJ1aWxkIHR5cGUgdG8gdGhlIHNldHRpbmdzLmpzb24uXG4gICAgICAgIHNldHRpbmdzLmVudiA9ICh0aGlzLiQuZW52LmlzUHJvZHVjdGlvbkJ1aWxkKCkpID9cbiAgICAgICAgICAgICdwcm9kJyA6ICdkZXYnO1xuXG4gICAgICAgIHNldHRpbmdzLm1ldGVvckRlc2t0b3BWZXJzaW9uID0gdGhpcy4kLmdldFZlcnNpb24oKTtcblxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKFxuICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5kZXNrdG9wVG1wLnNldHRpbmdzLCBKU09OLnN0cmluZ2lmeShzZXR0aW5ncywgbnVsbCwgNClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb3BpZXMgZmlsZXMgZnJvbSBwcmVwYXJlZCAuZGVza3RvcCB0byBkZXNrdG9wLmFzYXIgaW4gZWxlY3Ryb24gYXBwLlxuICAgICAqL1xuICAgIHBhY2tEZXNrdG9wVG9Bc2FyKCkge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKCdwYWNraW5nIC5kZXNrdG9wIHRvIGFzYXInKTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGFzYXIuY3JlYXRlUGFja2FnZShcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3BUbXAucm9vdCxcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLmRlc2t0b3BBc2FyLFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cudmVyYm9zZSgnY2xlYXJpbmcgdGVtcG9yYXJ5IC5kZXNrdG9wJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJC51dGlsc1xuICAgICAgICAgICAgICAgICAgICAgICAgLnJtV2l0aFJldHJpZXMoJy1yZicsIHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcFRtcC5yb290KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlcyBhIHRlbXBvcmFyeSBjb3B5IG9mIC5kZXNrdG9wLlxuICAgICAqL1xuICAgIGNvcHlEZXNrdG9wVG9EZXNrdG9wVGVtcCgpIHtcbiAgICAgICAgdGhpcy5sb2cudmVyYm9zZSgnY29weWluZyAuZGVza3RvcCB0byB0ZW1wb3JhcnkgbG9jYXRpb24nKTtcbiAgICAgICAgc2hlbGwuY3AoJy1yZicsIHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcC5yb290LCB0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3BUbXAucm9vdCk7XG4gICAgICAgIC8vIFJlbW92ZSB0ZXN0IGZpbGVzLlxuICAgICAgICBkZWwuc3luYyhbXG4gICAgICAgICAgICBwYXRoLmpvaW4odGhpcy4kLmVudi5wYXRocy5kZXNrdG9wVG1wLnJvb3QsICcqKicsICcqLnRlc3QuanMnKVxuICAgICAgICBdKTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIFJ1bnMgYmFiZWwgYW5kIHVnbGlmeSBvdmVyIC5kZXNrdG9wIGlmIHJlcXVlc3RlZC5cbiAgICAgKi9cbiAgICB0cmFuc3BpbGVBbmRNaW5pZnkoKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oJ3RyYW5zcGlsaW5nIGFuZCB1Z2xpZnlpbmcnKTtcblxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCk7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSAndWdsaWZ5T3B0aW9ucycgaW4gc2V0dGluZ3MgPyBzZXR0aW5ncy51Z2xpZnlPcHRpb25zIDoge307XG4gICAgICAgIG9wdGlvbnMuZnJvbVN0cmluZyA9IHRydWU7XG4gICAgICAgIGNvbnN0IHVnbGlmeWluZ0VuYWJsZWQgPSAndWdsaWZ5JyBpbiBzZXR0aW5ncyAmJiAhIXNldHRpbmdzLnVnbGlmeTtcblxuICAgICAgICAvLyBVbmZvcnR1bmF0ZWx5IGByZWlmeWAgd2lsbCBub3Qgd29yayB3aGVuIHdlIHJlcXVpcmUgYSAuanMgZmlsZSBmcm9tIGFuIGFzYXIgYXJjaGl2ZS5cbiAgICAgICAgLy8gU28gaGVyZSB3ZSB3aWxsIHRyYW5zcGlsZSAuZGVza3RvcCB0byBoYXZlIHRoZSBFUzYgbW9kdWxlcyB3b3JraW5nLlxuXG4gICAgICAgIC8vIFVnbGlmeSBkb2VzIG5vdCBoYW5kbGUgRVM2IHlldCwgc28gd2Ugd2lsbCBoYXZlIHRvIHRyYW5zcGlsZSB0byBFUzUgZm9yIG5vdy5cbiAgICAgICAgY29uc3QgcHJlc2V0ID0gKHVnbGlmeWluZ0VuYWJsZWQgJiYgc2V0dGluZ3MuZW52ID09PSAncHJvZCcpID9cbiAgICAgICAgICAgIGVzMjAxNVByZXNldCA6IG5vZGU2UHJlc2V0O1xuXG4gICAgICAgIGdsb2Iuc3luYyhgJHt0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3BUbXAucm9vdH0vKiovKi5qc2ApLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgICAgICAgIGxldCB7IGNvZGUgfSA9IHRyYW5zZm9ybUZpbGVTeW5jKGZpbGUsIHtcbiAgICAgICAgICAgICAgICBwcmVzZXRzOiBbcHJlc2V0XVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoc2V0dGluZ3MuZW52ID09PSAncHJvZCcgJiYgdWdsaWZ5aW5nRW5hYmxlZCkge1xuICAgICAgICAgICAgICAgIGNvZGUgPSB1Z2xpZnkubWluaWZ5KGNvZGUsIG9wdGlvbnMpLmNvZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGUsIGNvZGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNb3ZlcyBhbGwgdGhlIGZpbGVzIHRoYXQgc2hvdWxkIG5vdCBiZSBwYWNrZWQgaW50byBhc2FyIGludG8gYSBzYWZlIGxvY2F0aW9uIHdoaWNoIGlzIHRoZVxuICAgICAqICdleHRyYWN0ZWQnIGRpciBpbiB0aGUgZWxlY3Ryb24gYXBwLlxuICAgICAqL1xuICAgIGFzeW5jIGV4Y2x1ZGVGaWxlc0Zyb21BcmNoaXZlKCkge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKCdleGNsdWRpbmcgZmlsZXMgZnJvbSBwYWNraW5nJyk7XG5cbiAgICAgICAgLy8gRW5zdXJlIGVtcHR5IGBleHRyYWN0ZWRgIGRpclxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLiQudXRpbHMucm1XaXRoUmV0cmllcygnLXJmJywgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWQpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgIH1cblxuICAgICAgICBzaGVsbC5ta2Rpcih0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLmV4dHJhY3RlZCk7XG5cbiAgICAgICAgY29uc3QgY29uZmlncyA9IHRoaXMuJC5kZXNrdG9wLmdhdGhlck1vZHVsZUNvbmZpZ3MoKTtcblxuICAgICAgICAvLyBNb3ZlIGZpbGVzIHRoYXQgc2hvdWxkIG5vdCBiZSBhc2FyJ2VkLlxuICAgICAgICBjb25maWdzLmZvckVhY2goKGNvbmZpZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgbW9kdWxlQ29uZmlnID0gY29uZmlnO1xuICAgICAgICAgICAgaWYgKCdleHRyYWN0JyBpbiBtb2R1bGVDb25maWcpIHtcbiAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobW9kdWxlQ29uZmlnLmV4dHJhY3QpKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUNvbmZpZy5leHRyYWN0ID0gW21vZHVsZUNvbmZpZy5leHRyYWN0XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbW9kdWxlQ29uZmlnLmV4dHJhY3QuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhgZXhjbHVkaW5nICR7ZmlsZX0gZnJvbSAke2NvbmZpZy5uYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcFRtcC5tb2R1bGVzLCBtb2R1bGVDb25maWcuZGlyTmFtZSwgZmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uUGF0aCA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAuZXh0cmFjdGVkLCBtb2R1bGVDb25maWcuZGlyTmFtZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLiQudXRpbHMuZXhpc3RzKGRlc3RpbmF0aW9uUGF0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoZWxsLm1rZGlyKGRlc3RpbmF0aW9uUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc2hlbGwubXYoZmlsZVBhdGgsIGRlc3RpbmF0aW9uUGF0aCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==