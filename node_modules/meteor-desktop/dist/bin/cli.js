#!/usr/bin/env node
'use strict';

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _assignIn = require('lodash/assignIn');

var _assignIn2 = _interopRequireDefault(_assignIn);

var _commander = require('commander');

var _commander2 = _interopRequireDefault(_commander);

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _ = require('../..');

var _2 = _interopRequireDefault(_);

var _addScript = require('../scripts/utils/addScript');

var _addScript2 = _interopRequireDefault(_addScript);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

process.env.MD_LOG_LEVEL = 'ALL';
/* eslint-disable global-require */


var join = _path2.default.join;
var cmd = process.argv[2];

/* eslint-disable no-console */
var log = console.log;
var error = console.error;
var info = console.info;
var warn = console.warn;
/* eslint-enable no-console */

/**
 * Looks for .meteor directory.
 * @param {string} appPath - Meteor app path
 */
function isMeteorApp(appPath) {
    var meteorPath = join(appPath, '.meteor');
    try {
        return _fs2.default.statSync(meteorPath).isDirectory();
    } catch (e) {
        return false;
    }
}

/**
 * Just ensures a ddp url is set.
 *
 * @param {string|null} ddpUrl - the url that Meteor app connects to
 * @returns {string|null}
 */
function getDdpUrl() {
    var ddpUrl = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;

    if (!ddpUrl && _commander2.default.buildMeteor) {
        info('no ddp_url specified, setting default: http://127.0.0.1:3000');
        return 'http://127.0.0.1:3000';
    }
    return ddpUrl;
}

// --------------------------

_commander2.default.option('-b, --build-meteor', 'runs meteor to obtain the mobile build, kills it after').option('-t, --build-timeout <timeout_in_sec>', 'timeout value when waiting for ' + 'meteor to build, default 600sec').option('-p, --port <port>', 'port on which meteor is running, when with -b this will be passed to meteor when obtaining the build').option('--production', 'builds meteor app with the production switch, uglifies contents ' + 'of .desktop, packs app to app.asar').option('-a, --android', 'force adding android as a mobile platform instead of ios').option('-s, --scaffold', 'will scaffold .desktop if not present').option('--meteor-settings <path>', 'only with -b, adds --settings options to meteor').option('--ia32', 'generate 32bit installer/package').option('--all-archs', 'generate 32bit and 64bit installers').option('--win', 'generate Windows installer').option('--linux', 'generate Linux installer').option('--mac', 'generate Mac installer');

_commander2.default.usage('[command] [options]').version(require('./../../package.json').version, '-V, --version').on('--help', function () {
    log('  [ddp_url] - pass a ddp url if you want to use different one than used in meteor\'s --mobile-server');
    log('              this will also work with -b');
    log('    ');
    log('  Examples:');
    log('');
    log('   ', ['# cd into meteor dir first', 'cd /your/meteor/app', 'meteor --mobile-server=127.0.0.1:3000', '', '# open new terminal, assuming you have done npm install --save-dev meteor-desktop', 'npm run desktop -- init', 'npm run desktop'].join('\n    '));
    log('\n');
});

function verifyArgsSyntax() {
    if (process.env.npm_config_argv) {
        var npmArgv = void 0;
        try {
            (function () {
                var args = ['-b', '--build-meteor', '-t', '--build-timeout', '-p', '--port', '--production', '-a', '--android', '-s', '--scaffold', '--ia32', '--win', '--linux', '--all-archs', '--win', '--mac', '--meteor-settings'];
                npmArgv = JSON.parse(process.env.npm_config_argv);
                if (npmArgv.remain.length === 0 && npmArgv.original.length > 2) {
                    if (npmArgv.original.some(function (arg) {
                        return !!~args.indexOf(arg);
                    })) {
                        warn('WARNING: seems that you might used the wrong console syntax, no ` --' + ' ` delimiter was found, be sure you are invoking meteor-desktop with' + ' it when passing commands or options -> ' + '`npm run desktop -- command --option`\n');
                    }
                }
            })();
        } catch (e) {
            // Not sure if `npm_config_argv` is always present...
        }
    }
}

function meteorDesktopFactory(ddpUrl) {
    var production = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;

    info('METEOR-DESKTOP v' + require('./../../package.json').version + '\n');

    verifyArgsSyntax();

    var input = process.cwd();

    if (!isMeteorApp(input)) {
        error('not in a meteor app dir\n ' + input);
        process.exit();
    }

    if (!_commander2.default.output) {
        _commander2.default.output = input;
    }

    if (production && !_commander2.default.production) {
        info('package/build-installer implies setting --production, setting it for you');
    }

    if (!_commander2.default.buildMeteor) {
        _commander2.default.port = _commander2.default.port || 3000;
        info('REMINDER: your Meteor project should be running now on port ' + _commander2.default.port + '\n');
    }

    var options = {
        ddpUrl: ddpUrl,
        skipMobileBuild: _commander2.default.buildMeteor ? !_commander2.default.buildMeteor : true,
        production: _commander2.default.production || production
    };

    (0, _assignIn2.default)(options, _commander2.default);

    return (0, _2.default)(input, _commander2.default.output, options);
}

function run(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl)).run();
}

function build(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl)).build();
}

function init() {
    meteorDesktopFactory().init();
}

function justRun() {
    meteorDesktopFactory().justRun();
}

function runPackager(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl), true).runPackager();
}

function buildInstaller(ddpUrl) {
    meteorDesktopFactory(getDdpUrl(ddpUrl), true).buildInstaller();
}

function initTestsSupport() {
    log('installing cross-env, ava, meteor-desktop-test-suite and spectron');
    log('running `meteor npm install --save-dev cross-env ava spectron meteor-desktop-test-suite`');

    var code = _shelljs2.default.exec('meteor npm install --save-dev cross-env ava spectron meteor-desktop-test-suite').code;

    if (code !== 0) {
        warn('could not add cross-env, ava and spectron to your `devDependencies`, please do it' + ' manually');
    }

    var test = 'cross-env NODE_ENV=test ava .desktop/**/*.test.js -s --verbose';
    var testWatch = 'cross-env NODE_ENV=test ava .desktop/**/*.test.js -s --verbose' + ' --watch --source .desktop';

    function fail() {
        error('\ncould not add entries to `scripts` in package.json');
        log('please try to add it manually\n');
        log('test-desktop: ' + test);
        log('test-desktop-watch: ' + testWatch);
    }

    var packageJsonPath = _path2.default.resolve(_path2.default.join(process.cwd(), 'package.json'));

    (0, _addScript2.default)('test-desktop', test, packageJsonPath, fail);
    (0, _addScript2.default)('test-desktop-watch', testWatch, packageJsonPath, fail);

    log('\nadded test-desktop and test-desktop-watch entries');
    log('run the test with `npm run test-desktop`');
}

_commander2.default.command('init').description('scaffolds .desktop dir in the meteor app').action(init);

_commander2.default.command('run [ddp_url]').description('(default) builds and runs desktop app').action(run);

_commander2.default.command('build [ddp_url]').description('builds your desktop app').action(build);

_commander2.default.command('build-installer [ddp_url]').description('creates the installer').action(buildInstaller);

_commander2.default.command('just-run').description('alias for running `electron .` in `.meteor/desktop-build`').action(justRun);

_commander2.default.command('package [ddp_url]').description('runs electron packager').action(runPackager);

_commander2.default.command('init-tests-support').description('prepares project for running functional tests of desktop app').action(initTestsSupport);

if (process.argv.length === 2 || !~'-h|--help|run|init|build|build-installer|just-run|init-tests-support|package'.indexOf(cmd)) {
    var argv = process.argv;
    if (process.argv.length === 2) {
        argv.push('run');
    } else {
        var command = argv.splice(0, 2);
        command = command.concat('run', argv);
        argv = command;
    }
    _commander2.default.parse(argv);
} else {
    _commander2.default.parse(process.argv);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9iaW4vY2xpLmpzIl0sIm5hbWVzIjpbInByb2Nlc3MiLCJlbnYiLCJNRF9MT0dfTEVWRUwiLCJqb2luIiwiY21kIiwiYXJndiIsImxvZyIsImNvbnNvbGUiLCJlcnJvciIsImluZm8iLCJ3YXJuIiwiaXNNZXRlb3JBcHAiLCJhcHBQYXRoIiwibWV0ZW9yUGF0aCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJlIiwiZ2V0RGRwVXJsIiwiZGRwVXJsIiwiYnVpbGRNZXRlb3IiLCJvcHRpb24iLCJ1c2FnZSIsInZlcnNpb24iLCJyZXF1aXJlIiwib24iLCJ2ZXJpZnlBcmdzU3ludGF4IiwibnBtX2NvbmZpZ19hcmd2IiwibnBtQXJndiIsImFyZ3MiLCJKU09OIiwicGFyc2UiLCJyZW1haW4iLCJsZW5ndGgiLCJvcmlnaW5hbCIsInNvbWUiLCJpbmRleE9mIiwiYXJnIiwibWV0ZW9yRGVza3RvcEZhY3RvcnkiLCJwcm9kdWN0aW9uIiwiaW5wdXQiLCJjd2QiLCJleGl0Iiwib3V0cHV0IiwicG9ydCIsIm9wdGlvbnMiLCJza2lwTW9iaWxlQnVpbGQiLCJydW4iLCJidWlsZCIsImluaXQiLCJqdXN0UnVuIiwicnVuUGFja2FnZXIiLCJidWlsZEluc3RhbGxlciIsImluaXRUZXN0c1N1cHBvcnQiLCJjb2RlIiwiZXhlYyIsInRlc3QiLCJ0ZXN0V2F0Y2giLCJmYWlsIiwicGFja2FnZUpzb25QYXRoIiwicmVzb2x2ZSIsImNvbW1hbmQiLCJkZXNjcmlwdGlvbiIsImFjdGlvbiIsInB1c2giLCJzcGxpY2UiLCJjb25jYXQiXSwibWFwcGluZ3MiOiI7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7OztBQUVBQSxRQUFRQyxHQUFSLENBQVlDLFlBQVosR0FBMkIsS0FBM0I7QUFWQTs7O0FBWUEsSUFBTUMsT0FBTyxlQUFLQSxJQUFsQjtBQUNBLElBQU1DLE1BQU1KLFFBQVFLLElBQVIsQ0FBYSxD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TCxDQUFVLEtBQVY7QUFDSCxLQUZELE1BRU87QUFDSCxZQUFJSCxVQUFVdkQsS0FBSzJELE1BQUwsQ0FBWSxDQUFaLEVBQWUsQ0FBZixDQUFkO0FBQ0FKLGtCQUFVQSxRQUFRSyxNQUFSLENBQWUsS0FBZixFQUFzQjVELElBQXRCLENBQVY7QUFDQUEsZUFBT3VELE9BQVA7QUFDSDtBQUNELHdCQUFROUIsS0FBUixDQUFjekIsSUFBZDtBQUNILENBWEQsTUFXTztBQUNILHdCQUFReUIsS0FBUixDQUFjOUIsUUFBUUssSUFBdEI7QUFDSCIsImZpbGUiOiJjbGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8qIGVzbGludC1kaXNhYmxlIGdsb2JhbC1yZXF1aXJlICovXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgYXNzaWduSW4gZnJvbSAnbG9kYXNoL2Fzc2lnbkluJztcbmltcG9ydCBwcm9ncmFtIGZyb20gJ2NvbW1hbmRlcic7XG5pbXBvcnQgc2hlbGwgZnJvbSAnc2hlbGxqcyc7XG5cbmltcG9ydCBtZXRlb3JEZXNrdG9wIGZyb20gJy4uLy4uJztcbmltcG9ydCBhZGRTY3JpcHQgZnJvbSAnLi4vc2NyaXB0cy91dGlscy9hZGRTY3JpcHQnO1xuXG5wcm9jZXNzLmVudi5NRF9MT0dfTEVWRUwgPSAnQUxMJztcblxuY29uc3Qgam9pbiA9IHBhdGguam9pbjtcbmNvbnN0IGNtZCA9IHByb2Nlc3MuYXJndlsyXTtcblxuLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuY29uc3QgbG9nID0gY29uc29sZS5sb2c7XG5jb25zdCBlcnJvciA9IGNvbnNvbGUuZXJyb3I7XG5jb25zdCBpbmZvID0gY29uc29sZS5pbmZvO1xuY29uc3Qgd2FybiA9IGNvbnNvbGUud2Fybjtcbi8qIGVzbGludC1lbmFibGUgbm8tY29uc29sZSAqL1xuXG4vKipcbiAqIExvb2tzIGZvciAubWV0ZW9yIGRpcmVjdG9yeS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gTWV0ZW9yIGFwcCBwYXRoXG4gKi9cbmZ1bmN0aW9uIGlzTWV0ZW9yQXBwKGFwcFBhdGgpIHtcbiAgICBjb25zdCBtZXRlb3JQYXRoID0gam9pbihhcHBQYXRoLCAnLm1ldGVvcicpO1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBmcy5zdGF0U3luYyhtZXRlb3JQYXRoKS5pc0RpcmVjdG9yeSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cblxuLyoqXG4gKiBKdXN0IGVuc3VyZXMgYSBkZHAgdXJsIGlzIHNldC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ3xudWxsfSBkZHBVcmwgLSB0aGUgdXJsIHRoYXQgTWV0ZW9yIGFwcCBjb25uZWN0cyB0b1xuICogQHJldHVybnMge3N0cmluZ3xudWxsfVxuICovXG5mdW5jdGlvbiBnZXREZHBVcmwoZGRwVXJsID0gbnVsbCkge1xuICAgIGlmICghZGRwVXJsICYmIHByb2dyYW0uYnVpbGRNZXRlb3IpIHtcbiAgICAgICAgaW5mbygnbm8gZGRwX3VybCBzcGVjaWZpZWQsIHNldHRpbmcgZGVmYXVsdDogaHR0cDovLzEyNy4wLjAuMTozMDAwJyk7XG4gICAgICAgIHJldHVybiAnaHR0cDovLzEyNy4wLjAuMTozMDAwJztcbiAgICB9XG4gICAgcmV0dXJuIGRkcFVybDtcbn1cblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxucHJvZ3JhbVxuICAgIC5vcHRpb24oJy1iLCAtLWJ1aWxkLW1ldGVvcicsICdydW5zIG1ldGVvciB0byBvYnRhaW4gdGhlIG1vYmlsZSBidWlsZCwga2lsbHMgaXQgYWZ0ZXInKVxuICAgIC5vcHRpb24oJy10LCAtLWJ1aWxkLXRpbWVvdXQgPHRpbWVvdXRfaW5fc2VjPicsICd0aW1lb3V0IHZhbHVlIHdoZW4gd2FpdGluZyBmb3IgJyArXG4gICAgICAgICdtZXRlb3IgdG8gYnVpbGQsIGRlZmF1bHQgNjAwc2VjJylcbiAgICAub3B0aW9uKCctcCwgLS1wb3J0IDxwb3J0PicsICdwb3J0IG9uIHdoaWNoIG1ldGVvciBpcyBydW5uaW5nLCB3aGVuIHdpdGggLWIgdGhpcyB3aWxsIGJlIHBhc3NlZCB0byBtZXRlb3Igd2hlbiBvYnRhaW5pbmcgdGhlIGJ1aWxkJylcbiAgICAub3B0aW9uKCctLXByb2R1Y3Rpb24nLCAnYnVpbGRzIG1ldGVvciBhcHAgd2l0aCB0aGUgcHJvZHVjdGlvbiBzd2l0Y2gsIHVnbGlmaWVzIGNvbnRlbnRzICcgK1xuICAgICAgICAnb2YgLmRlc2t0b3AsIHBhY2tzIGFwcCB0byBhcHAuYXNhcicpXG4gICAgLm9wdGlvbignLWEsIC0tYW5kcm9pZCcsICdmb3JjZSBhZGRpbmcgYW5kcm9pZCBhcyBhIG1vYmlsZSBwbGF0Zm9ybSBpbnN0ZWFkIG9mIGlvcycpXG4gICAgLm9wdGlvbignLXMsIC0tc2NhZmZvbGQnLCAnd2lsbCBzY2FmZm9sZCAuZGVza3RvcCBpZiBub3QgcHJlc2VudCcpXG4gICAgLm9wdGlvbignLS1tZXRlb3Itc2V0dGluZ3MgPHBhdGg+JywgJ29ubHkgd2l0aCAtYiwgYWRkcyAtLXNldHRpbmdzIG9wdGlvbnMgdG8gbWV0ZW9yJylcbiAgICAub3B0aW9uKCctLWlhMzInLCAnZ2VuZXJhdGUgMzJiaXQgaW5zdGFsbGVyL3BhY2thZ2UnKVxuICAgIC5vcHRpb24oJy0tYWxsLWFyY2hzJywgJ2dlbmVyYXRlIDMyYml0IGFuZCA2NGJpdCBpbnN0YWxsZXJzJylcbiAgICAub3B0aW9uKCctLXdpbicsICdnZW5lcmF0ZSBXaW5kb3dzIGluc3RhbGxlcicpXG4gICAgLm9wdGlvbignLS1saW51eCcsICdnZW5lcmF0ZSBMaW51eCBpbnN0YWxsZXInKVxuICAgIC5vcHRpb24oJy0tbWFjJywgJ2dlbmVyYXRlIE1hYyBpbnN0YWxsZXInKTtcblxucHJvZ3JhbVxuICAgIC51c2FnZSgnW2NvbW1hbmRdIFtvcHRpb25zXScpXG4gICAgLnZlcnNpb24ocmVxdWlyZSgnLi8uLi8uLi9wYWNrYWdlLmpzb24nKS52ZXJzaW9uLCAnLVYsIC0tdmVyc2lvbicpXG4gICAgLm9uKCctLWhlbHAnLCAoKSA9PiB7XG4gICAgICAgIGxvZygnICBbZGRwX3VybF0gLSBwYXNzIGEgZGRwIHVybCBpZiB5b3Ugd2FudCB0byB1c2UgZGlmZmVyZW50IG9uZSB0aGFuIHVzZWQgaW4gbWV0ZW9yXFwncyAtLW1vYmlsZS1zZXJ2ZXInKTtcbiAgICAgICAgbG9nKCcgICAgICAgICAgICAgIHRoaXMgd2lsbCBhbHNvIHdvcmsgd2l0aCAtYicpO1xuICAgICAgICBsb2coJyAgICAnKTtcbiAgICAgICAgbG9nKCcgIEV4YW1wbGVzOicpO1xuICAgICAgICBsb2coJycpO1xuICAgICAgICBsb2coJyAgICcsXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgJyMgY2QgaW50byBtZXRlb3IgZGlyIGZpcnN0JyxcbiAgICAgICAgICAgICAgICAnY2QgL3lvdXIvbWV0ZW9yL2FwcCcsXG4gICAgICAgICAgICAgICAgJ21ldGVvciAtLW1vYmlsZS1zZXJ2ZXI9MTI3LjAuMC4xOjMwMDAnLFxuICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICcjIG9wZW4gbmV3IHRlcm1pbmFsLCBhc3N1bWluZyB5b3UgaGF2ZSBkb25lIG5wbSBpbnN0YWxsIC0tc2F2ZS1kZXYgbWV0ZW9yLWRlc2t0b3AnLFxuICAgICAgICAgICAgICAgICducG0gcnVuIGRlc2t0b3AgLS0gaW5pdCcsXG4gICAgICAgICAgICAgICAgJ25wbSBydW4gZGVza3RvcCdcbiAgICAgICAgICAgIF0uam9pbignXFxuICAgICcpXG4gICAgICAgICk7XG4gICAgICAgIGxvZygnXFxuJyk7XG4gICAgfSk7XG5cblxuZnVuY3Rpb24gdmVyaWZ5QXJnc1N5bnRheCgpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19hcmd2KSB7XG4gICAgICAgIGxldCBucG1Bcmd2O1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnLWInLCAnLS1idWlsZC1tZXRlb3InLCAnLXQnLCAnLS1idWlsZC10aW1lb3V0JywgJy1wJywgJy0tcG9ydCcsXG4gICAgICAgICAgICAgICAgJy0tcHJvZHVjdGlvbicsICctYScsICctLWFuZHJvaWQnLCAnLXMnLCAnLS1zY2FmZm9sZCcsICctLWlhMzInLCAnLS13aW4nLFxuICAgICAgICAgICAgICAgICctLWxpbnV4JywgJy0tYWxsLWFyY2hzJywgJy0td2luJywgJy0tbWFjJywgJy0tbWV0ZW9yLXNldHRpbmdzJ107XG4gICAgICAgICAgICBucG1Bcmd2ID0gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5ucG1fY29uZmlnX2FyZ3YpO1xuICAgICAgICAgICAgaWYgKG5wbUFyZ3YucmVtYWluLmxlbmd0aCA9PT0gMCAmJiBucG1Bcmd2Lm9yaWdpbmFsLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgICAgICAgICBpZiAobnBtQXJndi5vcmlnaW5hbC5zb21lKGFyZyA9PiAhIX5hcmdzLmluZGV4T2YoYXJnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgd2FybignV0FSTklORzogc2VlbXMgdGhhdCB5b3UgbWlnaHQgdXNlZCB0aGUgd3JvbmcgY29uc29sZSBzeW50YXgsIG5vIGAgLS0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICcgYCBkZWxpbWl0ZXIgd2FzIGZvdW5kLCBiZSBzdXJlIHlvdSBhcmUgaW52b2tpbmcgbWV0ZW9yLWRlc2t0b3Agd2l0aCcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJyBpdCB3aGVuIHBhc3NpbmcgY29tbWFuZHMgb3Igb3B0aW9ucyAtPiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdgbnBtIHJ1biBkZXNrdG9wIC0tIGNvbW1hbmQgLS1vcHRpb25gXFxuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBOb3Qgc3VyZSBpZiBgbnBtX2NvbmZpZ19hcmd2YCBpcyBhbHdheXMgcHJlc2VudC4uLlxuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBtZXRlb3JEZXNrdG9wRmFjdG9yeShkZHBVcmwsIHByb2R1Y3Rpb24gPSBmYWxzZSkge1xuICAgIGluZm8oYE1FVEVPUi1ERVNLVE9QIHYke3JlcXVpcmUoJy4vLi4vLi4vcGFja2FnZS5qc29uJykudmVyc2lvbn1cXG5gKTtcblxuICAgIHZlcmlmeUFyZ3NTeW50YXgoKTtcblxuICAgIGNvbnN0IGlucHV0ID0gcHJvY2Vzcy5jd2QoKTtcblxuICAgIGlmICghaXNNZXRlb3JBcHAoaW5wdXQpKSB7XG4gICAgICAgIGVycm9yKGBub3QgaW4gYSBtZXRlb3IgYXBwIGRpclxcbiAke2lucHV0fWApO1xuICAgICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb2dyYW0ub3V0cHV0KSB7XG4gICAgICAgIHByb2dyYW0ub3V0cHV0ID0gaW5wdXQ7XG4gICAgfVxuXG4gICAgaWYgKHByb2R1Y3Rpb24gJiYgIXByb2dyYW0ucHJvZHVjdGlvbikge1xuICAgICAgICBpbmZvKCdwYWNrYWdlL2J1aWxkLWluc3RhbGxlciBpbXBsaWVzIHNldHRpbmcgLS1wcm9kdWN0aW9uLCBzZXR0aW5nIGl0IGZvciB5b3UnKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb2dyYW0uYnVpbGRNZXRlb3IpIHtcbiAgICAgICAgcHJvZ3JhbS5wb3J0ID0gcHJvZ3JhbS5wb3J0IHx8IDMwMDA7XG4gICAgICAgIGluZm8oYFJFTUlOREVSOiB5b3VyIE1ldGVvciBwcm9qZWN0IHNob3VsZCBiZSBydW5uaW5nIG5vdyBvbiBwb3J0ICR7cHJvZ3JhbS5wb3J0fVxcbmApO1xuICAgIH1cblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgIGRkcFVybCxcbiAgICAgICAgc2tpcE1vYmlsZUJ1aWxkOiBwcm9ncmFtLmJ1aWxkTWV0ZW9yID8gIXByb2dyYW0uYnVpbGRNZXRlb3IgOiB0cnVlLFxuICAgICAgICBwcm9kdWN0aW9uOiBwcm9ncmFtLnByb2R1Y3Rpb24gfHwgcHJvZHVjdGlvblxuICAgIH07XG5cbiAgICBhc3NpZ25JbihvcHRpb25zLCBwcm9ncmFtKTtcblxuICAgIHJldHVybiBtZXRlb3JEZXNrdG9wKFxuICAgICAgICBpbnB1dCxcbiAgICAgICAgcHJvZ3JhbS5vdXRwdXQsXG4gICAgICAgIG9wdGlvbnNcbiAgICApO1xufVxuXG5mdW5jdGlvbiBydW4oZGRwVXJsKSB7XG4gICAgbWV0ZW9yRGVza3RvcEZhY3RvcnkoZ2V0RGRwVXJsKGRkcFVybCkpLnJ1bigpO1xufVxuXG5mdW5jdGlvbiBidWlsZChkZHBVcmwpIHtcbiAgICBtZXRlb3JEZXNrdG9wRmFjdG9yeShnZXREZHBVcmwoZGRwVXJsKSkuYnVpbGQoKTtcbn1cblxuZnVuY3Rpb24gaW5pdCgpIHtcbiAgICBtZXRlb3JEZXNrdG9wRmFjdG9yeSgpLmluaXQoKTtcbn1cblxuZnVuY3Rpb24ganVzdFJ1bigpIHtcbiAgICBtZXRlb3JEZXNrdG9wRmFjdG9yeSgpLmp1c3RSdW4oKTtcbn1cblxuZnVuY3Rpb24gcnVuUGFja2FnZXIoZGRwVXJsKSB7XG4gICAgbWV0ZW9yRGVza3RvcEZhY3RvcnkoZ2V0RGRwVXJsKGRkcFVybCksIHRydWUpLnJ1blBhY2thZ2VyKCk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkSW5zdGFsbGVyKGRkcFVybCkge1xuICAgIG1ldGVvckRlc2t0b3BGYWN0b3J5KGdldERkcFVybChkZHBVcmwpLCB0cnVlKS5idWlsZEluc3RhbGxlcigpO1xufVxuXG5mdW5jdGlvbiBpbml0VGVzdHNTdXBwb3J0KCkge1xuICAgIGxvZygnaW5zdGFsbGluZyBjcm9zcy1lbnYsIGF2YSwgbWV0ZW9yLWRlc2t0b3AtdGVzdC1zdWl0ZSBhbmQgc3BlY3Ryb24nKTtcbiAgICBsb2coJ3J1bm5pbmcgYG1ldGVvciBucG0gaW5zdGFsbCAtLXNhdmUtZGV2IGNyb3NzLWVudiBhdmEgc3BlY3Ryb24gbWV0ZW9yLWRlc2t0b3AtdGVzdC1zdWl0ZWAnKTtcblxuICAgIGNvbnN0IGNvZGUgPSBzaGVsbC5leGVjKCdtZXRlb3IgbnBtIGluc3RhbGwgLS1zYXZlLWRldiBjcm9zcy1lbnYgYXZhIHNwZWN0cm9uIG1ldGVvci1kZXNrdG9wLXRlc3Qtc3VpdGUnKS5jb2RlO1xuXG4gICAgaWYgKGNvZGUgIT09IDApIHtcbiAgICAgICAgd2FybignY291bGQgbm90IGFkZCBjcm9zcy1lbnYsIGF2YSBhbmQgc3BlY3Ryb24gdG8geW91ciBgZGV2RGVwZW5kZW5jaWVzYCwgcGxlYXNlIGRvIGl0JyArXG4gICAgICAgICAgICAnIG1hbnVhbGx5Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgdGVzdCA9ICdjcm9zcy1lbnYgTk9ERV9FTlY9dGVzdCBhdmEgLmRlc2t0b3AvKiovKi50ZXN0LmpzIC1zIC0tdmVyYm9zZSc7XG4gICAgY29uc3QgdGVzdFdhdGNoID0gJ2Nyb3NzLWVudiBOT0RFX0VOVj10ZXN0IGF2YSAuZGVza3RvcC8qKi8qLnRlc3QuanMgLXMgLS12ZXJib3NlJyArXG4gICAgICAgICcgLS13YXRjaCAtLXNvdXJjZSAuZGVza3RvcCc7XG5cbiAgICBmdW5jdGlvbiBmYWlsKCkge1xuICAgICAgICBlcnJvcignXFxuY291bGQgbm90IGFkZCBlbnRyaWVzIHRvIGBzY3JpcHRzYCBpbiBwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgbG9nKCdwbGVhc2UgdHJ5IHRvIGFkZCBpdCBtYW51YWxseVxcbicpO1xuICAgICAgICBsb2coYHRlc3QtZGVza3RvcDogJHt0ZXN0fWApO1xuICAgICAgICBsb2coYHRlc3QtZGVza3RvcC13YXRjaDogJHt0ZXN0V2F0Y2h9YCk7XG4gICAgfVxuXG4gICAgY29uc3QgcGFja2FnZUpzb25QYXRoID0gcGF0aC5yZXNvbHZlKFxuICAgICAgICBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3BhY2thZ2UuanNvbicpKTtcblxuICAgIGFkZFNjcmlwdCgndGVzdC1kZXNrdG9wJywgdGVzdCwgcGFja2FnZUpzb25QYXRoLCBmYWlsKTtcbiAgICBhZGRTY3JpcHQoJ3Rlc3QtZGVza3RvcC13YXRjaCcsIHRlc3RXYXRjaCwgcGFja2FnZUpzb25QYXRoLCBmYWlsKTtcblxuICAgIGxvZygnXFxuYWRkZWQgdGVzdC1kZXNrdG9wIGFuZCB0ZXN0LWRlc2t0b3Atd2F0Y2ggZW50cmllcycpO1xuICAgIGxvZygncnVuIHRoZSB0ZXN0IHdpdGggYG5wbSBydW4gdGVzdC1kZXNrdG9wYCcpO1xufVxuXG5wcm9ncmFtXG4gICAgLmNvbW1hbmQoJ2luaXQnKVxuICAgIC5kZXNjcmlwdGlvbignc2NhZmZvbGRzIC5kZXNrdG9wIGRpciBpbiB0aGUgbWV0ZW9yIGFwcCcpXG4gICAgLmFjdGlvbihpbml0KTtcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdydW4gW2RkcF91cmxdJylcbiAgICAuZGVzY3JpcHRpb24oJyhkZWZhdWx0KSBidWlsZHMgYW5kIHJ1bnMgZGVza3RvcCBhcHAnKVxuICAgIC5hY3Rpb24ocnVuKTtcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdidWlsZCBbZGRwX3VybF0nKVxuICAgIC5kZXNjcmlwdGlvbignYnVpbGRzIHlvdXIgZGVza3RvcCBhcHAnKVxuICAgIC5hY3Rpb24oYnVpbGQpO1xuXG5wcm9ncmFtXG4gICAgLmNvbW1hbmQoJ2J1aWxkLWluc3RhbGxlciBbZGRwX3VybF0nKVxuICAgIC5kZXNjcmlwdGlvbignY3JlYXRlcyB0aGUgaW5zdGFsbGVyJylcbiAgICAuYWN0aW9uKGJ1aWxkSW5zdGFsbGVyKTtcblxucHJvZ3JhbVxuICAgIC5jb21tYW5kKCdqdXN0LXJ1bicpXG4gICAgLmRlc2NyaXB0aW9uKCdhbGlhcyBmb3IgcnVubmluZyBgZWxlY3Ryb24gLmAgaW4gYC5tZXRlb3IvZGVza3RvcC1idWlsZGAnKVxuICAgIC5hY3Rpb24oanVzdFJ1bik7XG5cbnByb2dyYW1cbiAgICAuY29tbWFuZCgncGFja2FnZSBbZGRwX3VybF0nKVxuICAgIC5kZXNjcmlwdGlvbigncnVucyBlbGVjdHJvbiBwYWNrYWdlcicpXG4gICAgLmFjdGlvbihydW5QYWNrYWdlcik7XG5cbnByb2dyYW1cbiAgICAuY29tbWFuZCgnaW5pdC10ZXN0cy1zdXBwb3J0JylcbiAgICAuZGVzY3JpcHRpb24oJ3ByZXBhcmVzIHByb2plY3QgZm9yIHJ1bm5pbmcgZnVuY3Rpb25hbCB0ZXN0cyBvZiBkZXNrdG9wIGFwcCcpXG4gICAgLmFjdGlvbihpbml0VGVzdHNTdXBwb3J0KTtcblxuaWYgKHByb2Nlc3MuYXJndi5sZW5ndGggPT09IDIgfHwgIX4oJy1ofC0taGVscHxydW58aW5pdHxidWlsZHxidWlsZC1pbnN0YWxsZXJ8anVzdC1ydW58aW5pdC10ZXN0cy1zdXBwb3J0fHBhY2thZ2UnLmluZGV4T2YoY21kKSlcbikge1xuICAgIGxldCBhcmd2ID0gcHJvY2Vzcy5hcmd2O1xuICAgIGlmIChwcm9jZXNzLmFyZ3YubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIGFyZ3YucHVzaCgncnVuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGNvbW1hbmQgPSBhcmd2LnNwbGljZSgwLCAyKTtcbiAgICAgICAgY29tbWFuZCA9IGNvbW1hbmQuY29uY2F0KCdydW4nLCBhcmd2KTtcbiAgICAgICAgYXJndiA9IGNvbW1hbmQ7XG4gICAgfVxuICAgIHByb2dyYW0ucGFyc2UoYXJndik7XG59IGVsc2Uge1xuICAgIHByb2dyYW0ucGFyc2UocHJvY2Vzcy5hcmd2KTtcbn1cbiJdfQ==