'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _hashFiles = require('hash-files');

var _hashFiles2 = _interopRequireDefault(_hashFiles);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_shelljs2.default.config.fatal = true;

/**
 * Checks if the path is empty.
 * @param {string} searchPath
 * @returns {boolean}
 */
function isEmptySync(searchPath) {
    var stat = void 0;
    try {
        stat = _fs2.default.statSync(searchPath);
    } catch (e) {
        return true;
    }
    if (stat.isDirectory()) {
        var items = _fs2.default.readdirSync(searchPath);
        return !items || !items.length;
    }
    return false;
}

/**
 * Represents the .desktop directory.
 * @class
 * @property {desktopSettings} settings
 */

var Desktop = function () {

    /**
     * @param {MeteorDesktop} $ - context
     *
     * @constructor
     */
    function Desktop($) {
        (0, _classCallCheck3.default)(this, Desktop);

        this.$ = $;
        this.log = new _log2.default('desktop');
        this.settings = null;
    }

    /**
     * Tries to read and returns settings.json contents from .desktop dir.
     *
     * @returns {desktopSettings|null}
     */


    (0, _createClass3.default)(Desktop, [{
        key: 'getSettings',
        value: function getSettings() {
            if (!this.settings) {
                try {
                    this.settings = JSON.parse(_fs2.default.readFileSync(this.$.env.paths.desktop.settings, 'UTF-8'));
                } catch (e) {
                    this.log.error('error while trying to read \'.desktop/settings.json\': ', e);
                    process.exit(1);
                }
            }
            return this.settings;
        }

        /**
         * Returns a version hash representing current .desktop contents.
         * @returns {string}
         */

    }, {
        key: 'getHashVersion',
        value: function getHashVersion() {
            this.log.info('calculating hash version from .desktop contents');
            var version = _hashFiles2.default.sync({
                files: ['' + this.$.env.paths.desktop.root + _path2.default.sep + '**']
            });
            this.log.verbose('calculated .desktop hash version is ' + version);
            return version;
        }

        /**
         * Tries to read a module.json file from a module at provided path.
         *
         * @param {string} modulePath - path to the module dir
         * @returns {Object}
         */

    }, {
        key: 'getModuleConfig',
        value: function getModuleConfig(modulePath) {
            var moduleConfig = {};
            try {
                moduleConfig = JSON.parse(_fs2.default.readFileSync(_path2.default.join(modulePath, 'module.json'), 'UTF-8'));
            } catch (e) {
                this.log.error('error while trying to read \'module.json\' from \'' + modulePath + '\' module: ', e);
                process.exit(1);
            }
            if (!('name' in moduleConfig)) {
                this.log.error('no \'name\' field defined in \'module.json\' in \'' + modulePath + '\' module.');
                process.exit(1);
            }
            return moduleConfig;
        }

        /**
         * Scans all modules for module.json and gathers this configuration altogether.
         *
         * @returns {[]}
         */

    }, {
        key: 'gatherModuleConfigs',
        value: function gatherModuleConfigs() {
            var _this = this;

            var configs = [];

            if (!isEmptySync(this.$.env.paths.desktop.modules)) {
                _shelljs2.default.ls('-d', _path2.default.join(this.$.env.paths.desktop.modules, '*')).forEach(function (module) {
                    if (_fs2.default.lstatSync(module).isDirectory()) {
                        var moduleConfig = _this.getModuleConfig(module);
                        moduleConfig.dirName = _path2.default.parse(module).name;
                        configs.push(moduleConfig);
                    }
                });
            }
            return configs;
        }

        /**
         * Summarizes all dependencies defined in .desktop.
         *
         * @params {Object} settings      - settings.json
         * @params {boolean} checkModules - whether to gather modules dependencies
         * @returns {{fromSettings: {}, plugins: {}, modules: {}}}
         */

    }, {
        key: 'getDependencies',
        value: function getDependencies() {
            var _this2 = this;

            var settings = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;
            var checkModules = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

            var dependencies = {
                fromSettings: {},
                plugins: {},
                modules: {}
            };
            /** @type {desktopSettings} **/
            var settingsJson = settings || this.getSettings();

            // Settings can have a 'dependencies' field.
            if ('dependencies' in settingsJson) {
                dependencies.fromSettings = settingsJson.dependencies;
            }

            // Plugins are also a npm packages.
            if ('plugins' in settingsJson) {
                dependencies.plugins = (0, _keys2.default)(settingsJson.plugins).reduce(function (plugins, plugin) {
                    /* eslint-disable no-param-reassign */
                    if ((0, _typeof3.default)(settingsJson.plugins[plugin]) === 'object') {
                        plugins[plugin] = settingsJson.plugins[plugin].version;
                    } else {
                        plugins[plugin] = settingsJson.plugins[plugin];
                    }
                    return plugins;
                }, {});
            }

            // Each module can have its own dependencies defined.
            var moduleDependencies = {};
            if (checkModules) {
                var configs = this.gatherModuleConfigs();

                configs.forEach(function (moduleConfig) {
                    if (!('dependencies' in moduleConfig)) {
                        moduleConfig.dependencies = {};
                    }
                    if (moduleConfig.name in moduleDependencies) {
                        _this2.log.error('duplicate name \'' + moduleConfig.name + '\' in \'module.json\' in ' + ('\'' + moduleConfig.dirName + '\' - another module already registered the same name.'));
                        process.exit(1);
                    }
                    moduleDependencies[moduleConfig.name] = moduleConfig.dependencies;
                });
            }

            dependencies.modules = moduleDependencies;
            return dependencies;
        }

        /**
         * Copies the .desktop scaffold into the meteor app dir.
         * Adds entry to .meteor/.gitignore.
         */

    }, {
        key: 'scaffold',
        value: function scaffold() {
            this.log.info('creating .desktop scaffold in your project');

            if (this.$.utils.exists(this.$.env.paths.desktop.root)) {
                this.log.warn('.desktop already exists - delete it if you want a new one to be ' + 'created');
                return;
            }

            _shelljs2.default.cp('-r', this.$.env.paths.scaffold, this.$.env.paths.desktop.root);
            _shelljs2.default.mkdir(this.$.env.paths.desktop.import);
            this.log.info('.desktop directory prepared');
        }

        /**
         * Verifies if all mandatory files are present in the .desktop.
         *
         * @returns {boolean}
         */

    }, {
        key: 'check',
        value: function check() {
            this.log.verbose('checking .desktop existence');
            return !!(this.$.utils.exists(this.$.env.paths.desktop.root) && this.$.utils.exists(this.$.env.paths.desktop.settings) && this.$.utils.exists(this.$.env.paths.desktop.desktop));
        }
    }]);
    return Desktop;
}();

/**
 * @typedef {Object} desktopSettings
 * @property {string} name
 * @property {string} projectName
 * @property {boolean} devTools
 * @property {boolean} devtron
 * @property {boolean} desktopHCP
 * @property {string} autoUpdateFeedUrl
 * @property {Object} autoUpdateFeedHeaders
 * @property {Object} autoUpdateManualCheck
 * @property {Object} desktopHCPSettings
 * @property {boolean} desktopHCPSettings.ignoreCompatibilityVersion
 * @property {boolean} desktopHCPSettings.blockAppUpdateOnDesktopIncompatibility
 * @property {number} webAppStartupTimeout
 * @property {Object} window
 * @property {Object} windowDev
 * @property {Object} packageJsonFields
 * @property {Object} builderOptions
 * @property {Object} packagerOptions
 * @property {Object} plugins
 * @property {Object} dependencies
 * @property {boolean} uglify
 * @property {string} version
 **/


exports.default = Desktop;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9kZXNrdG9wLmpzIl0sIm5hbWVzIjpbImNvbmZpZyIsImZhdGFsIiwiaXNFbXB0eVN5bmMiLCJzZWFyY2hQYXRoIiwic3RhdCIsInN0YXRTeW5jIiwiZSIsImlzRGlyZWN0b3J5IiwiaXRlbXMiLCJyZWFkZGlyU3luYyIsImxlbmd0aCIsIkRlc2t0b3AiLCIkIiwibG9nIiwic2V0dGluZ3MiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJlbnYiLCJwYXRocyIsImRlc2t0b3AiLCJlcnJvciIsInByb2Nlc3MiLCJleGl0IiwiaW5mbyIsInZlcnNpb24iLCJzeW5jIiwiZmlsZXMiLCJyb290Iiwic2VwIiwidmVyYm9zZSIsIm1vZHVsZVBhdGgiLCJtb2R1bGVDb25maWciLCJqb2luIiwiY29uZmlncyIsIm1vZHVsZXMiLCJscyIsImZvckVhY2giLCJtb2R1bGUiLCJsc3RhdFN5bmMiLCJnZXRNb2R1bGVDb25maWciLCJkaXJOYW1lIiwibmFtZSIsInB1c2giLCJjaGVja01vZHVsZXMiLCJkZXBlbmRlbmNpZXMiLCJmcm9tU2V0dGluZ3MiLCJwbHVnaW5zIiwic2V0dGluZ3NKc29uIiwiZ2V0U2V0dGluZ3MiLCJyZWR1Y2UiLCJwbHVnaW4iLCJtb2R1bGVEZXBlbmRlbmNpZXMiLCJnYXRoZXJNb2R1bGVDb25maWdzIiwidXRpbHMiLCJleGlzdHMiLCJ3YXJuIiwiY3AiLCJzY2FmZm9sZCIsIm1rZGlyIiwiaW1wb3J0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7Ozs7O0FBRUEsa0JBQU1BLE1BQU4sQ0FBYUMsS0FBYixHQUFxQixJQUFyQjs7QUFFQTs7Ozs7QUFLQSxTQUFTQyxXQUFULENBQXFCQyxVQUFyQixFQUFpQztBQUM3QixRQUFJQyxhQUFKO0FBQ0EsUUFBSTtBQUNBQSxlQUFPLGFBQUdDLFFBQUgsQ0FBWUYsVUFBWixDQUFQO0FBQ0gsS0FG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TCxDQUFTVyxJQUFULENBQWMsNkJBQWQ7QUFDSDs7QUFFRDs7Ozs7Ozs7Z0NBS1E7QUFDSixpQkFBS1gsR0FBTCxDQUFTaUIsT0FBVCxDQUFpQiw2QkFBakI7QUFDQSxtQkFBTyxDQUFDLEVBQUUsS0FBS2xCLENBQUwsQ0FBTzBDLEtBQVAsQ0FBYUMsTUFBYixDQUFvQixLQUFLM0MsQ0FBTCxDQUFPTSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLE9BQWpCLENBQXlCUSxJQUE3QyxLQUNOLEtBQUtoQixDQUFMLENBQU8wQyxLQUFQLENBQWFDLE1BQWIsQ0FBb0IsS0FBSzNDLENBQUwsQ0FBT00sR0FBUCxDQUFXQyxLQUFYLENBQWlCQyxPQUFqQixDQUF5Qk4sUUFBN0MsQ0FETSxJQUVOLEtBQUtGLENBQUwsQ0FBTzBDLEtBQVAsQ0FBYUMsTUFBYixDQUFvQixLQUFLM0MsQ0FBTCxDQUFPTSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJDLE9BQWpCLENBQXlCQSxPQUE3QyxDQUZJLENBQVI7QUFHSDs7Ozs7QUFHTDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7a0JBdExxQlQsTyIsImZpbGUiOiJkZXNrdG9wLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNoZWxsIGZyb20gJ3NoZWxsanMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGhhc2ggZnJvbSAnaGFzaC1maWxlcyc7XG5cbmltcG9ydCBMb2cgZnJvbSAnLi9sb2cnO1xuXG5zaGVsbC5jb25maWcuZmF0YWwgPSB0cnVlO1xuXG4vKipcbiAqIENoZWNrcyBpZiB0aGUgcGF0aCBpcyBlbXB0eS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZWFyY2hQYXRoXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuZnVuY3Rpb24gaXNFbXB0eVN5bmMoc2VhcmNoUGF0aCkge1xuICAgIGxldCBzdGF0O1xuICAgIHRyeSB7XG4gICAgICAgIHN0YXQgPSBmcy5zdGF0U3luYyhzZWFyY2hQYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGNvbnN0IGl0ZW1zID0gZnMucmVhZGRpclN5bmMoc2VhcmNoUGF0aCk7XG4gICAgICAgIHJldHVybiAhaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgdGhlIC5kZXNrdG9wIGRpcmVjdG9yeS5cbiAqIEBjbGFzc1xuICogQHByb3BlcnR5IHtkZXNrdG9wU2V0dGluZ3N9IHNldHRpbmdzXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERlc2t0b3Age1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtNZXRlb3JEZXNrdG9wfSAkIC0gY29udGV4dFxuICAgICAqXG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoJCkge1xuICAgICAgICB0aGlzLiQgPSAkO1xuICAgICAgICB0aGlzLmxvZyA9IG5ldyBMb2coJ2Rlc2t0b3AnKTtcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJpZXMgdG8gcmVhZCBhbmQgcmV0dXJucyBzZXR0aW5ncy5qc29uIGNvbnRlbnRzIGZyb20gLmRlc2t0b3AgZGlyLlxuICAgICAqXG4gICAgICogQHJldHVybnMge2Rlc2t0b3BTZXR0aW5nc3xudWxsfVxuICAgICAqL1xuICAgIGdldFNldHRpbmdzKCkge1xuICAgICAgICBpZiAoIXRoaXMuc2V0dGluZ3MpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncyA9IEpTT04ucGFyc2UoXG4gICAgICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlU3luYyh0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3Auc2V0dGluZ3MsICdVVEYtOCcpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgdHJ5aW5nIHRvIHJlYWQgXFwnLmRlc2t0b3Avc2V0dGluZ3MuanNvblxcJzogJywgZSk7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgYSB2ZXJzaW9uIGhhc2ggcmVwcmVzZW50aW5nIGN1cnJlbnQgLmRlc2t0b3AgY29udGVudHMuXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBnZXRIYXNoVmVyc2lvbigpIHtcbiAgICAgICAgdGhpcy5sb2cuaW5mbygnY2FsY3VsYXRpbmcgaGFzaCB2ZXJzaW9uIGZyb20gLmRlc2t0b3AgY29udGVudHMnKTtcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9IGhhc2guc3luYyh7XG4gICAgICAgICAgICBmaWxlczogW2Ake3RoaXMuJC5lbnYucGF0aHMuZGVza3RvcC5yb290fSR7cGF0aC5zZXB9KipgXVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sb2cudmVyYm9zZShgY2FsY3VsYXRlZCAuZGVza3RvcCBoYXNoIHZlcnNpb24gaXMgJHt2ZXJzaW9ufWApO1xuICAgICAgICByZXR1cm4gdmVyc2lvbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmllcyB0byByZWFkIGEgbW9kdWxlLmpzb24gZmlsZSBmcm9tIGEgbW9kdWxlIGF0IHByb3ZpZGVkIHBhdGguXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlUGF0aCAtIHBhdGggdG8gdGhlIG1vZHVsZSBkaXJcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgICAqL1xuICAgIGdldE1vZHVsZUNvbmZpZyhtb2R1bGVQYXRoKSB7XG4gICAgICAgIGxldCBtb2R1bGVDb25maWcgPSB7fTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIG1vZHVsZUNvbmZpZyA9IEpTT04ucGFyc2UoXG4gICAgICAgICAgICAgICAgZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihtb2R1bGVQYXRoLCAnbW9kdWxlLmpzb24nKSwgJ1VURi04JylcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKFxuICAgICAgICAgICAgICAgIGBlcnJvciB3aGlsZSB0cnlpbmcgdG8gcmVhZCAnbW9kdWxlLmpzb24nIGZyb20gJyR7bW9kdWxlUGF0aH0nIG1vZHVsZTogYCxcbiAgICAgICAgICAgICAgICBlXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghKCduYW1lJyBpbiBtb2R1bGVDb25maWcpKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgbm8gJ25hbWUnIGZpZWxkIGRlZmluZWQgaW4gJ21vZHVsZS5qc29uJyBpbiAnJHttb2R1bGVQYXRofScgbW9kdWxlLmApO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtb2R1bGVDb25maWc7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2NhbnMgYWxsIG1vZHVsZXMgZm9yIG1vZHVsZS5qc29uIGFuZCBnYXRoZXJzIHRoaXMgY29uZmlndXJhdGlvbiBhbHRvZ2V0aGVyLlxuICAgICAqXG4gICAgICogQHJldHVybnMge1tdfVxuICAgICAqL1xuICAgIGdhdGhlck1vZHVsZUNvbmZpZ3MoKSB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3MgPSBbXTtcblxuICAgICAgICBpZiAoIWlzRW1wdHlTeW5jKHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcC5tb2R1bGVzKSkge1xuICAgICAgICAgICAgc2hlbGwubHMoJy1kJywgcGF0aC5qb2luKHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcC5tb2R1bGVzLCAnKicpKS5mb3JFYWNoKFxuICAgICAgICAgICAgICAgIChtb2R1bGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZzLmxzdGF0U3luYyhtb2R1bGUpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZUNvbmZpZyA9IHRoaXMuZ2V0TW9kdWxlQ29uZmlnKG1vZHVsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVDb25maWcuZGlyTmFtZSA9IHBhdGgucGFyc2UobW9kdWxlKS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlncy5wdXNoKG1vZHVsZUNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb25maWdzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1bW1hcml6ZXMgYWxsIGRlcGVuZGVuY2llcyBkZWZpbmVkIGluIC5kZXNrdG9wLlxuICAgICAqXG4gICAgICogQHBhcmFtcyB7T2JqZWN0fSBzZXR0aW5ncyAgICAgIC0gc2V0dGluZ3MuanNvblxuICAgICAqIEBwYXJhbXMge2Jvb2xlYW59IGNoZWNrTW9kdWxlcyAtIHdoZXRoZXIgdG8gZ2F0aGVyIG1vZHVsZXMgZGVwZW5kZW5jaWVzXG4gICAgICogQHJldHVybnMge3tmcm9tU2V0dGluZ3M6IHt9LCBwbHVnaW5zOiB7fSwgbW9kdWxlczoge319fVxuICAgICAqL1xuICAgIGdldERlcGVuZGVuY2llcyhzZXR0aW5ncyA9IG51bGwsIGNoZWNrTW9kdWxlcyA9IHRydWUpIHtcbiAgICAgICAgY29uc3QgZGVwZW5kZW5jaWVzID0ge1xuICAgICAgICAgICAgZnJvbVNldHRpbmdzOiB7fSxcbiAgICAgICAgICAgIHBsdWdpbnM6IHt9LFxuICAgICAgICAgICAgbW9kdWxlczoge31cbiAgICAgICAgfTtcbiAgICAgICAgLyoqIEB0eXBlIHtkZXNrdG9wU2V0dGluZ3N9ICoqL1xuICAgICAgICBjb25zdCBzZXR0aW5nc0pzb24gPSBzZXR0aW5ncyB8fCB0aGlzLmdldFNldHRpbmdzKCk7XG5cbiAgICAgICAgLy8gU2V0dGluZ3MgY2FuIGhhdmUgYSAnZGVwZW5kZW5jaWVzJyBmaWVsZC5cbiAgICAgICAgaWYgKCdkZXBlbmRlbmNpZXMnIGluIHNldHRpbmdzSnNvbikge1xuICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmZyb21TZXR0aW5ncyA9IHNldHRpbmdzSnNvbi5kZXBlbmRlbmNpZXM7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQbHVnaW5zIGFyZSBhbHNvIGEgbnBtIHBhY2thZ2VzLlxuICAgICAgICBpZiAoJ3BsdWdpbnMnIGluIHNldHRpbmdzSnNvbikge1xuICAgICAgICAgICAgZGVwZW5kZW5jaWVzLnBsdWdpbnMgPSBPYmplY3Qua2V5cyhzZXR0aW5nc0pzb24ucGx1Z2lucykucmVkdWNlKChwbHVnaW5zLCBwbHVnaW4pID0+IHtcbiAgICAgICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3NKc29uLnBsdWdpbnNbcGx1Z2luXSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGx1Z2luc1twbHVnaW5dID0gc2V0dGluZ3NKc29uLnBsdWdpbnNbcGx1Z2luXS52ZXJzaW9uO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBsdWdpbnNbcGx1Z2luXSA9IHNldHRpbmdzSnNvbi5wbHVnaW5zW3BsdWdpbl07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBwbHVnaW5zO1xuICAgICAgICAgICAgfSwge30pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRWFjaCBtb2R1bGUgY2FuIGhhdmUgaXRzIG93biBkZXBlbmRlbmNpZXMgZGVmaW5lZC5cbiAgICAgICAgY29uc3QgbW9kdWxlRGVwZW5kZW5jaWVzID0ge307XG4gICAgICAgIGlmIChjaGVja01vZHVsZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZ3MgPSB0aGlzLmdhdGhlck1vZHVsZUNvbmZpZ3MoKTtcblxuICAgICAgICAgICAgY29uZmlncy5mb3JFYWNoKFxuICAgICAgICAgICAgICAgIChtb2R1bGVDb25maWcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEoJ2RlcGVuZGVuY2llcycgaW4gbW9kdWxlQ29uZmlnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlQ29uZmlnLmRlcGVuZGVuY2llcyA9IHt9O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2R1bGVDb25maWcubmFtZSBpbiBtb2R1bGVEZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGBkdXBsaWNhdGUgbmFtZSAnJHttb2R1bGVDb25maWcubmFtZX0nIGluICdtb2R1bGUuanNvbicgaW4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYCcke21vZHVsZUNvbmZpZy5kaXJOYW1lfScgLSBhbm90aGVyIG1vZHVsZSBhbHJlYWR5IHJlZ2lzdGVyZWQgdGhlIHNhbWUgbmFtZS5gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBtb2R1bGVEZXBlbmRlbmNpZXNbbW9kdWxlQ29uZmlnLm5hbWVdID0gbW9kdWxlQ29uZmlnLmRlcGVuZGVuY2llcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVwZW5kZW5jaWVzLm1vZHVsZXMgPSBtb2R1bGVEZXBlbmRlbmNpZXM7XG4gICAgICAgIHJldHVybiBkZXBlbmRlbmNpZXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29waWVzIHRoZSAuZGVza3RvcCBzY2FmZm9sZCBpbnRvIHRoZSBtZXRlb3IgYXBwIGRpci5cbiAgICAgKiBBZGRzIGVudHJ5IHRvIC5tZXRlb3IvLmdpdGlnbm9yZS5cbiAgICAgKi9cbiAgICBzY2FmZm9sZCgpIHtcbiAgICAgICAgdGhpcy5sb2cuaW5mbygnY3JlYXRpbmcgLmRlc2t0b3Agc2NhZmZvbGQgaW4geW91ciBwcm9qZWN0Jyk7XG5cbiAgICAgICAgaWYgKHRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5kZXNrdG9wLnJvb3QpKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy53YXJuKCcuZGVza3RvcCBhbHJlYWR5IGV4aXN0cyAtIGRlbGV0ZSBpdCBpZiB5b3Ugd2FudCBhIG5ldyBvbmUgdG8gYmUgJyArXG4gICAgICAgICAgICAgICAgJ2NyZWF0ZWQnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHNoZWxsLmNwKCctcicsIHRoaXMuJC5lbnYucGF0aHMuc2NhZmZvbGQsIHRoaXMuJC5lbnYucGF0aHMuZGVza3RvcC5yb290KTtcbiAgICAgICAgc2hlbGwubWtkaXIodGhpcy4kLmVudi5wYXRocy5kZXNrdG9wLmltcG9ydCk7XG4gICAgICAgIHRoaXMubG9nLmluZm8oJy5kZXNrdG9wIGRpcmVjdG9yeSBwcmVwYXJlZCcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFZlcmlmaWVzIGlmIGFsbCBtYW5kYXRvcnkgZmlsZXMgYXJlIHByZXNlbnQgaW4gdGhlIC5kZXNrdG9wLlxuICAgICAqXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgY2hlY2soKSB7XG4gICAgICAgIHRoaXMubG9nLnZlcmJvc2UoJ2NoZWNraW5nIC5kZXNrdG9wIGV4aXN0ZW5jZScpO1xuICAgICAgICByZXR1cm4gISEodGhpcy4kLnV0aWxzLmV4aXN0cyh0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3Aucm9vdCkgJiZcbiAgICAgICAgICAgIHRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5kZXNrdG9wLnNldHRpbmdzKSAmJlxuICAgICAgICAgICAgdGhpcy4kLnV0aWxzLmV4aXN0cyh0aGlzLiQuZW52LnBhdGhzLmRlc2t0b3AuZGVza3RvcCkpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBkZXNrdG9wU2V0dGluZ3NcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcHJvamVjdE5hbWVcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGV2VG9vbHNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGV2dHJvblxuICogQHByb3BlcnR5IHtib29sZWFufSBkZXNrdG9wSENQXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXV0b1VwZGF0ZUZlZWRVcmxcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBhdXRvVXBkYXRlRmVlZEhlYWRlcnNcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBhdXRvVXBkYXRlTWFudWFsQ2hlY2tcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBkZXNrdG9wSENQU2V0dGluZ3NcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGVza3RvcEhDUFNldHRpbmdzLmlnbm9yZUNvbXBhdGliaWxpdHlWZXJzaW9uXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGRlc2t0b3BIQ1BTZXR0aW5ncy5ibG9ja0FwcFVwZGF0ZU9uRGVza3RvcEluY29tcGF0aWJpbGl0eVxuICogQHByb3BlcnR5IHtudW1iZXJ9IHdlYkFwcFN0YXJ0dXBUaW1lb3V0XG4gKiBAcHJvcGVydHkge09iamVjdH0gd2luZG93XG4gKiBAcHJvcGVydHkge09iamVjdH0gd2luZG93RGV2XG4gKiBAcHJvcGVydHkge09iamVjdH0gcGFja2FnZUpzb25GaWVsZHNcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBidWlsZGVyT3B0aW9uc1xuICogQHByb3BlcnR5IHtPYmplY3R9IHBhY2thZ2VyT3B0aW9uc1xuICogQHByb3BlcnR5IHtPYmplY3R9IHBsdWdpbnNcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBkZXBlbmRlbmNpZXNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdWdsaWZ5XG4gKiBAcHJvcGVydHkge3N0cmluZ30gdmVyc2lvblxuICoqL1xuIl19