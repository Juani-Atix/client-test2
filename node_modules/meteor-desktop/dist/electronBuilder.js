'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _electronBuilder = require('electron-builder');

var _yarn = require('electron-builder/out/yarn');

var _readPackageJson = require('electron-builder/out/util/readPackageJson');

var _shelljs = require('shelljs');

var _shelljs2 = _interopRequireDefault(_shelljs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Wrapper for electron-builder.
 */
var InstallerBuilder = function () {

    /**
     * @param {MeteorDesktop} $ - context
     *
     * @constructor
     */
    function InstallerBuilder($) {
        (0, _classCallCheck3.default)(this, InstallerBuilder);

        this.log = new _log2.default('electronBuilder');
        this.$ = $;
        this.firstPass = true;
        this.lastRebuild = {};
    }

    /**
     * Calls npm rebuild from electron-builder.
     * @param {string} arch
     * @param {string} platform
     * @returns {Promise}
     */


    (0, _createClass3.default)(InstallerBuilder, [{
        key: 'installOrRebuild',
        value: function () {
            var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(arch) {
                var platform = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : process.platform;
                var devMetadata, results;
                return _regenerator2.default.wrap(function _callee$(_context) {
                    while (1) {
                        switch (_context.prev = _context.next) {
                            case 0:
                                this.log.debug('calling installOrRebuild from electron-builder for arch ' + arch);
                                _context.next = 3;
                                return (0, _readPackageJson.readPackageJson)(this.$.env.paths.meteorApp.packageJson);

                            case 3:
                                devMetadata = _context.sent;
                                _context.next = 6;
                                return (0, _readPackageJson.getElectronVersion)(devMetadata, this.$.env.paths.meteorApp.root);

                            case 6:
                                results = _context.sent;

                                this.lastRebuild = { platform: platform, arch: arch };
                                _context.next = 10;
                                return (0, _yarn.installOrRebuild)(this.$.desktop.getSettings().builderOptions || {}, this.$.env.paths.electronApp.root, results, platform, arch, false);

                            case 10:
                            case 'end':
                                return _context.stop();
                        }
                    }
                }, _callee, this);
            }));

            function installOrRebuild(_x) {
                return _ref.apply(this, arguments);
            }

            return installOrRebuild;
        }()

        /**
         * Callback invoked before build is made. Ensures that app.asar have the right rebuilt
         * node_modules.
         *
         * @param {Object} context
         * @returns {Promise}
         */

    }, {
        key: 'beforeBuild',
        value: function beforeBuild(context) {
            var _this = this;

            return new _promise2.default(function (resolve) {
                var platformMatches = process.platform === context.platform.nodeName;
                var rebuild = platformMatches && context.arch !== _this.lastRebuild.arch;
                if (!platformMatches) {
                    _this.log.warn('skipping dependencies rebuild because platform is different, if you have native ' + 'node modules as your app dependencies you should od the build on the target platform only');
                }

                if (!rebuild) {
                    _this.moveNodeModulesOut();
                    resolve(false);
                } else {
                    _this.installOrRebuild(context.arch, context.platform.nodeName).then(function () {
                        _this.$.electronApp.scaffold.createAppRoot();
                        _this.$.electronApp.scaffold.copySkeletonApp();
                        return _this.$.electronApp.packSkeletonToAsar([_this.$.env.paths.electronApp.meteorAsar, _this.$.env.paths.electronApp.desktopAsar, _this.$.env.paths.electronApp.extracted]);
                    }).then(function () {
                        _this.moveNodeModulesOut();
                        resolve(false);
                    });
                }
            });
        }

        /**
         * Callback to be invoked after packing. Restores node_modules to the .desktop-build.
         * @returns {Promise}
         */

    }, {
        key: 'afterPack',
        value: function afterPack() {
            var _this2 = this;

            return new _promise2.default(function (resolve) {
                _this2.log.debug('moving node_modules back');
                // Move node_modules back.
                _shelljs2.default.mv(_this2.$.env.paths.electronApp.tmpNodeModules, _this2.$.env.paths.electronApp.nodeModules);

                if (_this2.firstPass) {
                    _this2.firstPass = false;
                }

                resolve();
            });
        }

        /**
         * Prepares the target object passed to the electron-builder.
         *
         * @returns {Map<Platform, Map<Arch, Array<string>>>}
         */

    }, {
        key: 'prepareTargets',
        value: function prepareTargets() {
            var arch = this.$.env.options.ia32 ? 'ia32' : 'x64';
            arch = this.$.env.options.allArchs ? 'all' : arch;

            var targets = [];

            if (this.$.env.options.win) {
                targets.push(_electronBuilder.Platform.WINDOWS);
            }
            if (this.$.env.options.linux) {
                targets.push(_electronBuilder.Platform.LINUX);
            }
            if (this.$.env.options.mac) {
                targets.push(_electronBuilder.Platform.MAC);
            }

            if (targets.length === 0) {
                if (this.$.env.os.isWindows) {
                    targets.push(_electronBuilder.Platform.WINDOWS);
                } else if (this.$.env.os.isLinux) {
                    targets.push(_electronBuilder.Platform.LINUX);
                } else {
                    targets.push(_electronBuilder.Platform.MAC);
                }
            }
            return (0, _electronBuilder.createTargets)(targets, null, arch);
        }
    }, {
        key: 'build',
        value: function () {
            var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2() {
                var settings, builderOptions;
                return _regenerator2.default.wrap(function _callee2$(_context2) {
                    while (1) {
                        switch (_context2.prev = _context2.next) {
                            case 0:
                                settings = this.$.desktop.getSettings();

                                if (!('builderOptions' in settings)) {
                                    this.log.error('no builderOptions in settings.json, aborting');
                                    process.exit(1);
                                }

                                builderOptions = (0, _assign2.default)({}, settings.builderOptions);


                                builderOptions.asar = false;
                                builderOptions.npmRebuild = true;

                                builderOptions.beforeBuild = this.beforeBuild.bind(this);
                                builderOptions.afterPack = this.afterPack.bind(this);

                                builderOptions.directories = {
                                    app: this.$.env.paths.electronApp.root,
                                    output: _path2.default.join(this.$.env.options.output, this.$.env.paths.installerDir)
                                };

                                _context2.prev = 8;
                                _context2.next = 11;
                                return (0, _electronBuilder.build)({
                                    targets: this.prepareTargets(),
                                    config: builderOptions
                                });

                            case 11:
                                _context2.next = 16;
                                break;

                            case 13:
                                _context2.prev = 13;
                                _context2.t0 = _context2['catch'](8);

                                this.log.error('error while building installer: ', _context2.t0);

                            case 16:
                            case 'end':
                                return _context2.stop();
                        }
                    }
                }, _callee2, this, [[8, 13]]);
            }));

            function build() {
                return _ref2.apply(this, arguments);
            }

            return build;
        }()
    }, {
        key: 'moveNodeModulesOut',
        value: function moveNodeModulesOut() {
            this.log.debug('moving node_modules out, because we have them already in' + ' app.asar');
            _shelljs2.default.mv(this.$.env.paths.electronApp.nodeModules, this.$.env.paths.electronApp.tmpNodeModules);
        }
    }]);
    return InstallerBuilder;
}();

exports.default = InstallerBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9lbGVjdHJvbkJ1aWxkZXIuanMiXSwibmFtZXMiOlsiSW5zdGFsbGVyQnVpbGRlciIsIiQiLCJsb2ciLCJmaXJzdFBhc3MiLCJsYXN0UmVidWlsZCIsImFyY2giLCJwbGF0Zm9ybSIsInByb2Nlc3MiLCJkZWJ1ZyIsImVudiIsInBhdGhzIiwibWV0ZW9yQXBwIiwicGFja2FnZUpzb24iLCJkZXZNZXRhZGF0YSIsInJvb3QiLCJyZXN1bHRzIiwiZGVza3RvcCIsImdldFNldHRpbmdzIiwiYnVpbGRlck9wdGlvbnMiLCJlbGVjdHJvbkFwcCIsImNvbnRleHQiLCJyZXNvbHZlIiwicGxhdGZvcm1NYXRjaGVzIiwibm9kZU5hbWUiLCJyZWJ1aWxkIiwid2FybiIsIm1vdmVOb2RlTW9kdWxlc091dCIsImluc3RhbGxPclJlYnVpbGQiLCJ0aGVuIiwic2NhZmZvbGQiLCJjcmVhdGVBcHBSb290IiwiY29weVNrZWxldG9uQXBwIiwicGFja1NrZWxldG9uVG9Bc2FyIiwibWV0ZW9yQXNhciIsImRlc2t0b3BBc2FyIiwiZXh0cmFjdGVkIiwibXYiLCJ0bXBOb2RlTW9kdWxlcyIsIm5vZGVNb2R1bGVzIiwib3B0aW9ucyIsImlhMzIiLCJhbGxBcmNocyIsInRhcmdldHMiLCJ3aW4iLCJwdXNoIiwiV0lORE9XUyIsImxpbnV4IiwiTElOVVgiLCJtYWMiLCJNQUMiLCJsZW5ndGgiLCJvcyIsImlzV2luZG93cyIsImlzTGludXgiLCJzZXR0aW5ncyIsImVycm9yIiwiZXhpdCIsImFzYXIiLCJucG1SZWJ1aWxkIiwiYmVmb3JlQnVpbGQiLCJiaW5kIiwiYWZ0ZXJQYWNrIiwiZGlyZWN0b3JpZXMiLCJhcHAiLCJvdXRwdXQiLCJqb2luIiwiaW5zdGFsbGVyRGlyIiwicHJlcGFyZVRhcmdldHMiLCJjb25maWciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7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O3VDQU1VLDRCQUFNO0FBQ1J4Qiw2Q0FBUyxLQUFLeUIsY0FBTCxFQUREO0FBRVJDLDRDQUFRbEQ7QUFGQSxpQ0FBTixDOzs7Ozs7Ozs7O0FBS04scUNBQUtoQixHQUFMLENBQVNxRCxLQUFULENBQWUsa0NBQWY7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs2Q0FJYTtBQUNqQixpQkFBS3JELEdBQUwsQ0FBU00sS0FBVCxDQUFlLDZEQUNYLFdBREo7QUFFQSw4QkFBTTRCLEVBQU4sQ0FDSSxLQUFLbkMsQ0FBTCxDQUFPUSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJTLFdBQWpCLENBQTZCbUIsV0FEakMsRUFFSSxLQUFLckMsQ0FBTCxDQUFPUSxHQUFQLENBQVdDLEtBQVgsQ0FBaUJTLFdBQWpCLENBQTZCa0IsY0FGakM7QUFJSDs7Ozs7a0JBbEtnQnJDLGdCIiwiZmlsZSI6ImVsZWN0cm9uQnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJ1aWxkLCBQbGF0Zm9ybSwgY3JlYXRlVGFyZ2V0cyB9IGZyb20gJ2VsZWN0cm9uLWJ1aWxkZXInO1xuaW1wb3J0IHsgaW5zdGFsbE9yUmVidWlsZCB9IGZyb20gJ2VsZWN0cm9uLWJ1aWxkZXIvb3V0L3lhcm4nO1xuaW1wb3J0IHsgZ2V0RWxlY3Ryb25WZXJzaW9uLCByZWFkUGFja2FnZUpzb24gfSBmcm9tICdlbGVjdHJvbi1idWlsZGVyL291dC91dGlsL3JlYWRQYWNrYWdlSnNvbic7XG5pbXBvcnQgc2hlbGwgZnJvbSAnc2hlbGxqcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBMb2cgZnJvbSAnLi9sb2cnO1xuXG4vKipcbiAqIFdyYXBwZXIgZm9yIGVsZWN0cm9uLWJ1aWxkZXIuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEluc3RhbGxlckJ1aWxkZXIge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtNZXRlb3JEZXNrdG9wfSAkIC0gY29udGV4dFxuICAgICAqXG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoJCkge1xuICAgICAgICB0aGlzLmxvZyA9IG5ldyBMb2coJ2VsZWN0cm9uQnVpbGRlcicpO1xuICAgICAgICB0aGlzLiQgPSAkO1xuICAgICAgICB0aGlzLmZpcnN0UGFzcyA9IHRydWU7XG4gICAgICAgIHRoaXMubGFzdFJlYnVpbGQgPSB7fTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBucG0gcmVidWlsZCBmcm9tIGVsZWN0cm9uLWJ1aWxkZXIuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGFyY2hcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBhc3luYyBpbnN0YWxsT3JSZWJ1aWxkKGFyY2gsIHBsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybSkge1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhgY2FsbGluZyBpbnN0YWxsT3JSZWJ1aWxkIGZyb20gZWxlY3Ryb24tYnVpbGRlciBmb3IgYXJjaCAke2FyY2h9YCk7XG4gICAgICAgIGNvbnN0IGRldk1ldGFkYXRhID0gYXdhaXQgcmVhZFBhY2thZ2VKc29uKHRoaXMuJC5lbnYucGF0aHMubWV0ZW9yQXBwLnBhY2thZ2VKc29uKTtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IGdldEVsZWN0cm9uVmVyc2lvbihkZXZNZXRhZGF0YSxcbiAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMubWV0ZW9yQXBwLnJvb3QpO1xuICAgICAgICB0aGlzLmxhc3RSZWJ1aWxkID0geyBwbGF0Zm9ybSwgYXJjaCB9O1xuICAgICAgICBhd2FpdCBpbnN0YWxsT3JSZWJ1aWxkKHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCkuYnVpbGRlck9wdGlvbnMgfHwge30sXG4gICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnJvb3QsIHJlc3VsdHMsIHBsYXRmb3JtLCBhcmNoLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgaW52b2tlZCBiZWZvcmUgYnVpbGQgaXMgbWFkZS4gRW5zdXJlcyB0aGF0IGFwcC5hc2FyIGhhdmUgdGhlIHJpZ2h0IHJlYnVpbHRcbiAgICAgKiBub2RlX21vZHVsZXMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIGJlZm9yZUJ1aWxkKGNvbnRleHQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwbGF0Zm9ybU1hdGNoZXMgPSBwcm9jZXNzLnBsYXRmb3JtID09PSBjb250ZXh0LnBsYXRmb3JtLm5vZGVOYW1lO1xuICAgICAgICAgICAgY29uc3QgcmVidWlsZCA9IHBsYXRmb3JtTWF0Y2hlcyAmJiBjb250ZXh0LmFyY2ggIT09IHRoaXMubGFzdFJlYnVpbGQuYXJjaDtcbiAgICAgICAgICAgIGlmICghcGxhdGZvcm1NYXRjaGVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cud2Fybignc2tpcHBpbmcgZGVwZW5kZW5jaWVzIHJlYnVpbGQgYmVjYXVzZSBwbGF0Zm9ybSBpcyBkaWZmZXJlbnQsIGlmIHlvdSBoYXZlIG5hdGl2ZSAnICtcbiAgICAgICAgICAgICAgICAgICAgJ25vZGUgbW9kdWxlcyBhcyB5b3VyIGFwcCBkZXBlbmRlbmNpZXMgeW91IHNob3VsZCBvZCB0aGUgYnVpbGQgb24gdGhlIHRhcmdldCBwbGF0Zm9ybSBvbmx5Jyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcmVidWlsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMubW92ZU5vZGVNb2R1bGVzT3V0KCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFsbE9yUmVidWlsZChjb250ZXh0LmFyY2gsIGNvbnRleHQucGxhdGZvcm0ubm9kZU5hbWUpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbGVjdHJvbkFwcC5zY2FmZm9sZC5jcmVhdGVBcHBSb290KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZWxlY3Ryb25BcHAuc2NhZmZvbGQuY29weVNrZWxldG9uQXBwKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kLmVsZWN0cm9uQXBwLnBhY2tTa2VsZXRvblRvQXNhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAubWV0ZW9yQXNhcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5kZXNrdG9wQXNhcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdmVOb2RlTW9kdWxlc091dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayB0byBiZSBpbnZva2VkIGFmdGVyIHBhY2tpbmcuIFJlc3RvcmVzIG5vZGVfbW9kdWxlcyB0byB0aGUgLmRlc2t0b3AtYnVpbGQuXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICovXG4gICAgYWZ0ZXJQYWNrKCkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdtb3Zpbmcgbm9kZV9tb2R1bGVzIGJhY2snKTtcbiAgICAgICAgICAgIC8vIE1vdmUgbm9kZV9tb2R1bGVzIGJhY2suXG4gICAgICAgICAgICBzaGVsbC5tdihcbiAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnRtcE5vZGVNb2R1bGVzLFxuICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAubm9kZU1vZHVsZXNcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmZpcnN0UGFzcykge1xuICAgICAgICAgICAgICAgIHRoaXMuZmlyc3RQYXNzID0gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJlcGFyZXMgdGhlIHRhcmdldCBvYmplY3QgcGFzc2VkIHRvIHRoZSBlbGVjdHJvbi1idWlsZGVyLlxuICAgICAqXG4gICAgICogQHJldHVybnMge01hcDxQbGF0Zm9ybSwgTWFwPEFyY2gsIEFycmF5PHN0cmluZz4+Pn1cbiAgICAgKi9cbiAgICBwcmVwYXJlVGFyZ2V0cygpIHtcbiAgICAgICAgbGV0IGFyY2ggPSB0aGlzLiQuZW52Lm9wdGlvbnMuaWEzMiA/ICdpYTMyJyA6ICd4NjQnO1xuICAgICAgICBhcmNoID0gdGhpcy4kLmVudi5vcHRpb25zLmFsbEFyY2hzID8gJ2FsbCcgOiBhcmNoO1xuXG4gICAgICAgIGNvbnN0IHRhcmdldHMgPSBbXTtcblxuICAgICAgICBpZiAodGhpcy4kLmVudi5vcHRpb25zLndpbikge1xuICAgICAgICAgICAgdGFyZ2V0cy5wdXNoKFBsYXRmb3JtLldJTkRPV1MpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLiQuZW52Lm9wdGlvbnMubGludXgpIHtcbiAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5MSU5VWCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuJC5lbnYub3B0aW9ucy5tYWMpIHtcbiAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5NQUMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRhcmdldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBpZiAodGhpcy4kLmVudi5vcy5pc1dpbmRvd3MpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXRzLnB1c2goUGxhdGZvcm0uV0lORE9XUyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuJC5lbnYub3MuaXNMaW51eCkge1xuICAgICAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5MSU5VWCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5NQUMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjcmVhdGVUYXJnZXRzKHRhcmdldHMsIG51bGwsIGFyY2gpO1xuICAgIH1cblxuICAgIGFzeW5jIGJ1aWxkKCkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCk7XG4gICAgICAgIGlmICghKCdidWlsZGVyT3B0aW9ucycgaW4gc2V0dGluZ3MpKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihcbiAgICAgICAgICAgICAgICAnbm8gYnVpbGRlck9wdGlvbnMgaW4gc2V0dGluZ3MuanNvbiwgYWJvcnRpbmcnKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJ1aWxkZXJPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgc2V0dGluZ3MuYnVpbGRlck9wdGlvbnMpO1xuXG4gICAgICAgIGJ1aWxkZXJPcHRpb25zLmFzYXIgPSBmYWxzZTtcbiAgICAgICAgYnVpbGRlck9wdGlvbnMubnBtUmVidWlsZCA9IHRydWU7XG5cbiAgICAgICAgYnVpbGRlck9wdGlvbnMuYmVmb3JlQnVpbGQgPSB0aGlzLmJlZm9yZUJ1aWxkLmJpbmQodGhpcyk7XG4gICAgICAgIGJ1aWxkZXJPcHRpb25zLmFmdGVyUGFjayA9IHRoaXMuYWZ0ZXJQYWNrLmJpbmQodGhpcyk7XG5cbiAgICAgICAgYnVpbGRlck9wdGlvbnMuZGlyZWN0b3JpZXMgPSB7XG4gICAgICAgICAgICBhcHA6IHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAucm9vdCxcbiAgICAgICAgICAgIG91dHB1dDogcGF0aC5qb2luKHRoaXMuJC5lbnYub3B0aW9ucy5vdXRwdXQsIHRoaXMuJC5lbnYucGF0aHMuaW5zdGFsbGVyRGlyKVxuICAgICAgICB9O1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBidWlsZCh7XG4gICAgICAgICAgICAgICAgdGFyZ2V0czogdGhpcy5wcmVwYXJlVGFyZ2V0cygpLFxuICAgICAgICAgICAgICAgIGNvbmZpZzogYnVpbGRlck9wdGlvbnNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igd2hpbGUgYnVpbGRpbmcgaW5zdGFsbGVyOiAnLCBlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1vdmVOb2RlTW9kdWxlc091dCgpIHtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ21vdmluZyBub2RlX21vZHVsZXMgb3V0LCBiZWNhdXNlIHdlIGhhdmUgdGhlbSBhbHJlYWR5IGluJyArXG4gICAgICAgICAgICAnIGFwcC5hc2FyJyk7XG4gICAgICAgIHNoZWxsLm12KFxuICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcyxcbiAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAudG1wTm9kZU1vZHVsZXNcbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=